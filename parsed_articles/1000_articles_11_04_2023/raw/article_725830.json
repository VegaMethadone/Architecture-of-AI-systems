{
    "article_id": "725830",
    "article_name": "Траблшутинг на Yealink. Часть 2. Сбор и первичный анализ логов",
    "content": "Во второй части статьи (\nсм. часть 1\n) мы обсудим алгоритм сбора логов на телефонах Yealink, их запись и экспорт, доступные к настройке опции сбора логов, а также поговорим о том, как произвести самостоятельный первичный анализ логов. \nКроме того, ниже мы рассмотрим некоторые вопросы, касающиеся сбора/передачи логов третьей стороне (производитель, дистрибьютор) и открытия тикетов в тикетных системах производителя/дистрибьютора. \n1. Запись сетевого лога (Pcap)\nТелефоны Yealink могут осуществлять запись сетевого лога. Лог можно настраивать и выгружать в веб-интерфейсе устройств. \nДля записи сетевого лога средствами телефона необходимо выполнить следующие действия. \n \t 1. Авторизуйтесь в веб-интерфейсе телефона. \n \t 2. Откройте вкладку \nНастройки — Конфигурации — Pcap.\n \nPcap (старый веб-интерфейс)\nPcap (новый веб-интерфейс)\n3. Выберите тип логирования. Опция \nВ память телефона\n подойдет, если объем трафика небольшой, а воспроизведение проблемы займет не более 5 минут. В ином случае рекомендуется выбрать опцию \nВ память ПК\n. \n4. Нажмите \nСтарт\n, воспроизведите проблему, нажмите \nСтоп\n. \n5. Если в п. 3 был выбран режим записи в память телефона, после остановки записи необходимо нажать \nЭкспорт\n. Если запись производилась в память ПК, файл логирования будет находиться в папке загрузок браузера. \nПодсказки для упрощения самостоятельного анализа сетевого лога\nПодсказка 1 \nиспользуйте фильтр SIP, чтобы в списке остались только SIP-сообщения;\nиспользуйте фильтры http, dhcp, rtp, rtsp и пр., чтобы в списке остались сообщения определенного типа;\nчтобы выполнить фильтрацию по IP-адресу, используйте фильтры ip.addr = 1.1.1.1, ip.src == 1.1.1.1, ip.dst == 1.1.1.2,  \nгде id.addr — IP-адрес, ip.src — IP-адрес источника, ip.dst — IP-адрес получателя;\nкомбинируйте фильтры ($$ — логическое И, || — логическое ИЛИ, ! — логическое НЕ).\nПодсказка 2 \nдля просмотра совершенных вызовов используйте меню \nТелефония — Вызовы VOIP — Последовательность потоков;\nдля просмотра и прослушивания RTP-потоков используйте меню \nТелефония — RTP — Потоки RTP.\nДополнительно:\n существуют иные методы записи сетевого лога, которые используются, если проблему сложно воспроизвести самостоятельно, или тогда, когда по какой-то причине записывать логи через веб-интерфейс не представляется возможным. \n1. Можно настроить зеркалирование порта Internet телефона в порт PC, а затем перехватить трафик с помощью Wireshark или другого перехватчика сетевого трафика.\nПримечание:\n алгоритм зеркалирования трафика с помощью телефона описан в \nпервой части данной статьи, п. 5\n. \n2. Можно настроить зеркалирование порта на коммутаторе (трафик с порта, к которому подключен телефон, зеркалируется на любой другой порт, к которому подключен ПК с Wireshark или другим перехватчиком сетевого трафика. Данный метод требует наличия управляемого коммутатора с поддержкой соответствующей функции. \nЗахват и сохранение трафика с помощью Wireshark \n1. Скачайте Wireshark. \n2. Откройте Wireshark и выберите интерфейс захвата с помощью двойного щелчка левой кнопкой мыши на названии интерфейса. \n3. Убедитесь в открывшемся окне, что захват трафика начался. \n4. Когда воспроизведение проблемы завершено, лог необходимо остановить и выгрузить. Сделать это можно следующим образом. \nВ левом верхнем углу нажмите на кнопку \nОстановить захват пакетов\n. \nЗатем нажмите \nФайл — Сохранить как\n и сохраните файл в память ПК. \n2. Запись системного лога (local log и syslog)\nСистемный лог — стандартное для Unix-устройств логирование системных событий. На телефонах Yealink предоставлено 2 варианта записи системного лога: local log и syslog. Оба варианта записи могут быть выгружены пользователем; также пользователь может произвести их самостоятельный анализ, т. к. записи не зашифрованы и могут быть открыты с помощью текстового редактора (Блокнот, Notepad++). \nLocal log\nТелефоны Yealink ведут запись системного лога local log в режиме реального времени при настройках по умолчанию. Логи хранятся в оперативной памяти устройства и будут потеряны при его перезагрузке. \nПо умолчанию логирование ведется на 3 уровне, а максимальный размер лог-файла, в зависимости от модели устройства, может быть ограничен. \nДля траблшутинга логи следует записывать на максимальном, 6 уровне логирования. Уровень логирования необходимо устанавливать заранее, до того, как проблема будет зафиксирована. \nКак записать и произвести выгрузку лога local log \n1. Перейдите в веб-интерфейс устройства.\nВеб-интерфейс: \nНастройки — Конфигурации — Local Log\n \nLocal log (старый веб-интерфейс)\nLocal log (новый веб-интерфейс)\n2. Установите следующие параметры:\nEnable local log = Enable\nLocal Log Level = 6\n \nМаксимальный размер лог-файла = 2048KB (необходимо установить максимально допустимое значение; для флагманских устройств размер лог-файла может быть выше и составлять, например, 20480KB). \n3. Если устройство поддерживает настройку параметра \nЛогирование модуля\n, параметр \nУровень логирования модуля\n должен быть установлен, как \nAll, 6\n.\nВеб-интерфейс: \nНастройки — Конфигурации — Логирование модуля\n \n4. Сохраните параметры записи логов нажатием клавиши \nСохранить\n.\nВеб-интерфейс: \nНастройки — Конфигурации — Сохранить\n \n5. После проявления инцидента выполните экспорт файла логов.\nВеб-интерфейс: \nНастройки — Конфигурации — Local log — Экспорт\n \n  \nПримечание1:\n Системный лог local log состоит из нескольких файлов, среди которых:\n  \nboot.log\n — лог, отображающий процесс загрузки устройства;\n  \nsystem_dump.log\n — лог, отображающий текущее состояние устройства;\n  \nMAC.log.X\n — файлы системного лога. \nSyslog \nТелефоны Yealink могут вести запись системного лога на внешний syslog-сервер. Данная опция требует предварительной настройки: необходимо запустить и настроить сервер, а также настроить функцию логирования на самом телефоне. \nКак записывать и выгружать лог syslog \n1. Настройте серверную часть. В качестве примера простейшего syslog-сервера возьмем TFTPD64, развернутый локально на ПК. \nСсылка на скачивание\n \nВнешний вид пользовательского интерфейса программы TFTPD64\n2. Настройте клиентскую часть (веб-интерфейс телефона).\nВеб-интерфейс: \nНастройки — Конфигурации — Syslog\n \nМинимально необходимые настройки: включение логирования, указание адреса сервера и порта, указание уровня логирования. \nSyslog (старый веб-интерфейс)\nSyslog (новый веб-интерфейс)\nОпционально можно задать другие параметры логирования, их описание приведено ниже:\nSyslog Server\n — URL-адрес syslog-сервера;\nПорт\n — порт syslog-сервера, по умолчанию — 514;\nSyslog Transport Type\n — транспортный протокол логирования;\nSyslog Level\n — уровень логирования. Для дебага (большинство случаев) необходимо установить 6 уровень. Для траблшутинга некоторых специфических проблем можно понизить уровень логирования (подробнее — далее в этой статье);\nSyslog Facility\n — опции генерации сообщений системного лога согласно RFC 3164;\nSyslog Prepend MAC\n — добавлять MAC-адрес к сообщениям системного лога;\nАвтоматический экспорт системного журнала на USB\n — запись системного лога на USB-носитель (для телефонов с USB-портом). \n3. Если устройство поддерживает настройку параметра \nЛогирование модуля\n, параметр \nУровень логирования модуля\n должен быть установлен, как \nAll, 6\n.\nВеб-интерфейс: \nНастройки — Конфигурации — Логирование модуля\n \n4. Выгрузите записанный лог с syslog-сервера. \nНа примере TFTPD64: нажмите клавишу \nCopy\n и вставьте содержимое в текстовый файл. \nКратко об опции Логирование модуля \nОпция \nЛогирование модуля (Module log)\n была добавлена к прошивкам 86 поколения для некоторых устройств и предназначена для более тонкой настройки логирования системного лога (local log и syslog).\nВеб-интерфейс: \nНастройки — Конфигурации — Логирование модуля\n \nЛогирование модуля (старый веб-интерфейс)\nЛогирование модуля (новый веб-интерфейс)\nУровень логирования задается двумя параметрами: \nуровень логирования от 0 до 6 (чем выше уровень, тем больше записей содержит лог);\nопределение типа записей, которые будут попадать в лог — например, события операционной системы, передачи голоса и видео, драйверов и пр.\n3. Логи для техподдержки и экспорт всех диагностических файлов\nПравильно собранные логи, прикрепленные к тикету при его открытии, могут существенно ускорить рассмотрение заявки, и, как следствие, решение возникшей проблемы. Рассмотрим, какой же пакет логов будет оптимально предоставить в том или ином случае, а также как правильно собирать логи. \nСтандартный пакет логов для открытия тикета в тикетной системе Yealink выглядит следующим образом: \nсистемный лог local log;\ncетевой лог;\nполная конфигурация config.bin;\nопционально для проблем, связанных с качеством речи — аудиодиагностика.\nПримечание 1.\n При записи системного лога (local log или syslog) можно самостоятельно убедиться, что логирование ведется на нужном уровне, по наличию сообщений с нужным уровнем логирования (уровень записи системного лога определяется по наивысшему уровню сообщений непосредственно на момент проявления проблемы). \nЭта запись системного лога ведется на 6 уровне логирования\n \nПримечание 2.\n Опция \nЛогирование модуля (Module log)\n задает компоненты логирования при записи системного лога syslog, local log (ОС, драйвер, периферия, протокол и пр.). Диапазон допустимых значений — от 0 до 6, при этом, чем выше уровень, тем больше компонентов логирования, и, соответственно, больше сообщений. \nПримечание 3.\n Все 4 файла (системный лог, сетевой лог, конфигурация, аудиодиагностика) можно выгрузить одновременно с помощью опции \nЭкспорт\n всех файлов диагностики. \nВажно:\n при экспорте логов данным способом необходимо установить параметр \nLocal log level\n в значение \n6\n и (при необходимости) указать максимальный размер лог-файла (параметр \nМаксимальный размер лог-файла\n в настройках local log). На устройствах, где есть опция \nModule log level\n, ее значение также необходимо выставить на \nAll, 6\n.\nВеб-интерфейс: \nНастройки — Конфигурации — Диагностика — Экспорт всех файлов диагностики\n \nЭкспорт всех файлов диагностики (старый веб-интерфейс)\nЭкспорт всех файлов диагностики (новый веб-интерфейс)\nОбращение в техническую поддержку дистрибьютора или реселлера\nКак правило, дистрибьютор или реселлер не предъявляют каких-либо конкретных требования к логам, которые нужно предоставить при открытии тикета. Однако, как и случае с тикетной системой производителя, своевременное предоставление правильно собранного пакета логов может ускорить рассмотрение тикета. Рассмотрим данную ситуацию на примере тикетной системы компании АйПиМатика. \nПри оформлении заявки через сайт support.ipmatika.ru пользователю будет предложено заполнить форму заявки, к которой можно прикрепить файлы. \nПрикрепление файлов к новому тикету\n \nПрикрепите к тикету логи, на основании которых (по мнению технического специалиста) может быть выявлена возникшая в системе проблема. \nЕсли же понимания специфики проблемы нет, в качестве универсального набора логов могут выступить сетевой лог, системный лог (local log или syslog) и конфигурационный файл CFG. \n \n ",
    "tags": [
        "настройка",
        "туториал",
        "траблшутинг",
        "ip-телефония"
    ]
}