{
    "article_id": "727510",
    "article_name": "–ú–∏—Ä –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–π –ø–æ API-—Å–µ—Ä–≤–µ—Ä—É Kubernetes. –ß–∞—Å—Ç—å 2. –ù–∞–±–ª—é–¥–µ–Ω–∏–µ –∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ",
    "content": "–í –Ω–∞—à–µ–π –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å—Ç–∞—Ç—å–µ –ø—Ä–æ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞ Kubernetes API –º—ã —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–ª–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–ª–∏ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –≤ –¥–µ—Ä–µ–≤–µ: etcd3. –û–¥–Ω–∞–∫–æ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–æ—á—Ç–µ–Ω–∏–µ —Å–Ω–æ—Å–æ–∫ –≤ —ç—Ç–æ–º –ø–æ—Å—Ç–µ –ø–æ–∫–∞–∑–∞–ª–æ, —á—Ç–æ –º—ã –±—ã–ª–∏ –Ω–µ —Å–æ–≤—Å–µ–º —á–µ—Å—Ç–Ω—ã–º–∏, –≥–æ–≤–æ—Ä—è, —á—Ç–æ etcd3 ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è.\n–≠—Ç–æ –º–æ–∂–Ω–æ –æ—Å–ø–æ—Ä–∏—Ç—å, –≤–µ–¥—å Cacher —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π, —Ö–æ—Ç—è –µ–º—É –∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –±–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è. –ü–æ–¥—Ä–æ–±–Ω–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –æ–¥–Ω–æ–º –∏–∑ –±—É–¥—É—â–∏—Ö –ø–æ—Å—Ç–æ–≤. –ê —Å–µ–π—á–∞—Å –ø–æ–¥—Ä–æ–±–Ω–æ –∏–∑—É—á–∏–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –µ–≥–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏.¬†\n–û —á—ë–º –ø–æ–≥–æ–≤–æ—Ä–∏–º –≤ —Å—Ç–∞—Ç—å–µ:\n \n–ù–∞–±–ª—é–¥–µ–Ω–∏–µ (üëà ¬´–Ø —Ö–æ—á—É –ø—Ä–æ–±–ª–µ–º—É –∏ –µ–µ —Ä–µ—à–µ–Ω–∏–µ¬ª);\n–í—Å–µ —Å–º–æ—Ç—Ä—è—Ç;\n–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (üëà ¬´–ú–Ω–µ –ø—Ä–æ—Å—Ç–æ –Ω—É–∂–Ω–æ —Ä–µ—à–µ–Ω–∏–µ¬ª);\nwatchCache \n;\ncacherListerWatcher \n;\nReflector\n;\n–°–≤—è–∂–µ–º –≤—Å—ë –≤–º–µ—Å—Ç–µ;¬†\n–ú–µ—Ç–æ–¥ \n¬†Watch()\n;\n–í—Å–µ —Å–º–æ—Ç—Ä—è—Ç‚Ä¶ –£—Å–ø–µ—à–Ω–æ (üëà ¬´–ü—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∂–∏—Ç–µ –º–Ω–µ –∫–æ–¥¬ª).\n–ù–∞–±–ª—é–¥–µ–Ω–∏–µ\n–ü—Ä–µ–∂–¥–µ —á–µ–º –º—ã –≤–≤–µ–¥–µ–º –∫–∞–∫–æ–π-–ª–∏–±–æ —Ç–∏–ø –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è, —Å—Ç–æ–∏—Ç –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ç–æ–º—É —Ñ–∞–∫—Ç—É, —á—Ç–æ \nstorage.Interface\n –≤–∫–ª—é—á–∞–µ—Ç –≤ —Å–µ–±—è –º–µ—Ç–æ–¥ \nWatch\n, —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è \netcd3\n¬†\n–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –µ–≥–æ\n. –†–∞–Ω–µ–µ \n–º—ã –∏–∑—É—á–∞–ª–∏\n –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π, –æ–±—Ä–∞—â–∞—è—Å—å –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –∫ \netcd\n —Å –ø–æ–º–æ—â—å—é \netcdctl\n. \netcd\n –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç \nWatch API\n, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–≤—É–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–æ—Ç–æ–∫–∏ gRPC –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ —Å–æ–±—ã—Ç–∏–π –∫–ª–∏–µ–Ω—Ç–∞–º –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è \n–∫–ª—é—á–∞\n.\n–†–µ–∞–ª–∏–∑–∞—Ü–∏—è etcd3 Watch \n—Å–æ–∑–¥–∞–µ—Ç \nwatch.Interface\n, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π \nwatcher\n. –ù–æ–≤—ã–π \nwatcher\n —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ \nWatch\n, –∏ –∫–∞–∂–¥—ã–π \nwatcher\n, –ø–æ —Å—É—Ç–∏, –ø—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç \netcd\n Watch API –∏ –ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –ø–æ –∫–∞–Ω–∞–ª—É.\n–î–∞–≤–∞–π—Ç–µ –≤–æ–∑—å–º–µ–º –Ω–∞—à—É –ø—Ä–æ–≥—Ä–∞–º–º—É –∏–∑ \n–ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø–æ—Å—Ç–∞\n –∏ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –µ—ë, —á—Ç–æ–±—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–æ –≤—Å–µ—Ö \nConfigMaps\n –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ.\n–í—ã –º–æ–∂–µ—Ç–µ –Ω–∞–π—Ç–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –æ —Ç–æ–º, –∫–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ PCI, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è —Å–≤—è–∑–∏ —Å \netcd\n –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ \nkind\n, \n–∑–¥–µ—Å—å\n.\ndirectwatch.go\npackage main\n\nimport (\n\t\"context\"\n\t\"fmt\"\n\n\t\"go.etcd.io/etcd/client/pkg/v3/transport\"\n\tclientv3 \"go.etcd.io/etcd/client/v3\"\n\tv1 \"k8s.io/api/core/v1\"\n\t\"k8s.io/apimachinery/pkg/runtime\"\n\t\"k8s.io/apimachinery/pkg/runtime/serializer\"\n\t\"k8s.io/apiserver/pkg/storage\"\n\t\"k8s.io/apiserver/pkg/storage/etcd3\"\n\t\"k8s.io/apiserver/pkg/storage/value/encrypt/identity\"\n\t\"k8s.io/kubernetes/pkg/apis/core\"\n\tk8sv1 \"k8s.io/kubernetes/pkg/apis/core/v1\"\n)\n\nfunc main() {\n\ttlsConfig, err := (transport.TLSInfo{\n\t\tCertFile:       \"./pki/etcd/server.crt\",\n\t\tKeyFile:        \"./pki/etcd/server.key\",\n\t\tTrustedCAFile:  \"./pki/etcd/ca.crt\",\n\t\tClientCertFile: \"./pki/apiserver-etcd-client.crt\",\n\t\tClientKeyFile:  \"./pki/apiserver-etcd-client.key\",\n\t}).ClientConfig()\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tc, err := clientv3.New(clientv3.Config{\n\t\tEndpoints: []string{\"https://127.0.0.1:2379\"},\n\t\tTLS:       tlsConfig,\n\t})\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\n\tscheme := runtime.NewScheme()\n\tk8sv1.AddToScheme(scheme)\n\tcore.AddToScheme(scheme)\n\tf := serializer.NewCodecFactory(scheme)\n\ts := etcd3.New(c, f.CodecForVersions(nil, f.UniversalDecoder(), nil, k8sv1.SchemeGroupVersion), nil, \"registry\", v1.Resource(\"ConfigMap\"), identity.NewEncryptCheckTransformer(), true, etcd3.NewDefaultLeaseManagerConfig())\n\tw, err := s.Watch(context.Background(), \"configmaps\", storage.ListOptions{\n\t\tPredicate: storage.Everything,\n\t\tRecursive: true,\n\t})\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tfor e := range w.ResultChan() {\n\t\tco, ok := e.Object.(*v1.ConfigMap)\n\t\tif !ok {\n\t\t\tpanic(\"not a config map!\")\n\t\t}\n\t\tfmt.Printf(\"%s || %s/%s\\n\", e.Type, co.Namespace, co.Name)\n\t}\n}\n–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Ç–æ—Ç —Ñ–∞–∫—Ç, —á—Ç–æ –º—ã —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ç–∏–ø—ã –∏–∑ \nk8s.io/kubernetes\n —Å–∫–æ—Ä–µ–µ, —á–µ–º \nk8s.io/api\n. –≠—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ \ninternal\n –≤–µ—Ä—Å–∏–∏ –≤ –Ω–∞—à—É –∂–µ–ª–∞–µ–º—É—é –≤–µ—Ä—Å–∏—é (\nv1\n). –ú—ã —Ç–∞–∫–∂–µ –ø–µ—Ä–µ–¥–∞–µ–º \nnil ¬†CodecForVersions,\n –ø–æ—Å–∫–æ–ª—å–∫—É –¥–µ–∫–æ–¥–∏—Ä—É–µ–º –∏—Ö —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏–π –ø–æ—Ç–æ–∫–∞.\n–ï—Å–ª–∏ —É –≤–∞—Å –∑–∞–ø—É—â–µ–Ω –∫–ª–∞—Å—Ç–µ—Ä \nkind\n, –≤—ã –º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ä—Ç–æ–≤ \netcd Pod\n.\n$ kubectl port-forward -n kube-system pod/etcd-kind-control-plane 2379:2379\n–¢–µ–ø–µ—Ä—å –º—ã –º–æ–∂–µ–º –Ω–∞—á–∞—Ç—å –Ω–∞—à—É –ø—Ä–æ–≥—Ä–∞–º–º—É.\n$ go run directwatch.go\nADDED || default/kube-root-ca.crt\nADDED || kube-node-lease/kube-root-ca.crt\nADDED || kube-public/cluster-info\nADDED || kube-public/kube-root-ca.crt\nADDED || kube-system/coredns\nADDED || kube-system/extension-apiserver-authentication\nADDED || kube-system/kube-proxy\nADDED || kube-system/kube-root-ca.crt\nADDED || kube-system/kubeadm-config\nADDED || kube-system/kubelet-config\nADDED || local-path-storage/kube-root-ca.crt\nADDED || local-path-storage/local-path-config\n–ö–∞–∫ –∏ –æ–∂–∏–¥–∞–ª–æ—Å—å, –º—ã –ø–æ–ª—É—á–∞–µ–º \nADDED\n —Å–æ–±—ã—Ç–∏—è –¥–ª—è –≤—Å–µ—Ö \nConfigMaps\n, –Ω–∞—Ö–æ–¥—è—â–∏—Ö—Å—è –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ. –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å, –æ–±–Ω–æ–≤–ª—è—Ç—å –∏ —É–¥–∞–ª—è—Ç—å \nConfigMap\n, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å, –∫–∞–∫ –¥—Ä—É–≥–∏–µ —Å–æ–±—ã—Ç–∏—è –æ—Ç—Ä–∞–∂–∞—é—Ç—Å—è –≤ –ø–æ—Ç–æ–∫–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞.\n$ kubectl create configmap k8s-asa --from-literal hello=world\nconfigmap/k8s-asa created\n\n$ kubectl create configmap k8s-asa --from-literal hello=asa -o yaml --dry-run | kubectl apply -f -\nconfigmap/k8s-asa configured\n\n$ kubectl delete configmap k8s-asa\nconfigmap \"k8s-asa\" deleted\n–ü–æ—Å–º–æ—Ç—Ä–∏–º –Ω–∞ –∫–∞–∂–¥–æ–µ –∏–∑ —ç—Ç–∏—Ö —Å–æ–±—ã—Ç–∏–π –≤ –ø–æ—Ç–æ–∫–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º —Ç–∏–ø–æ–º.\nADDED || default/k8s-asa\nMODIFIED || default/k8s-asa\nDELETED || default/k8s-asa\n–û–±—â–µ–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ\n–¢–µ–ø–µ—Ä—å –º—ã –º–æ–∂–µ–º –ø–æ–ª—É—á–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è, –∫–æ–≥–¥–∞ –º–µ–Ω—è–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–π –Ω–∞—Å —Ç–∏–ø, –∏ –Ω–µ –ø–æ—Ö–æ–∂–µ, —á—Ç–æ \netcd\n –∏–ª–∏ –Ω–∞—à–∞ –º–∞–ª–µ–Ω—å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Å–∏–ª—å–Ω–æ ¬´–ø–æ—Ç–µ—é—Ç¬ª. –ù–æ –¥–∞–≤–∞–π—Ç–µ –≤–∑–≥–ª—è–Ω–µ–º –Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ \netcd\n, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è –≤ —ç—Ç–æ–º. –ú—ã –º–æ–∂–µ–º –Ω–∞–π—Ç–∏ –æ—Ç–∫—Ä—ã—Ç—ã–π –∞–¥—Ä–µ—Å –º–µ—Ç—Ä–∏–∫ –¥–ª—è \netcd\n –≤ –Ω–∞—à–µ–º –∫–ª–∞—Å—Ç–µ—Ä–µ \nkind\n, –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–≤ –∫–æ–º–∞–Ω–¥—É –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ –º–æ–¥—É–ª–µ \nPod\n.\n$ kubectl get pod -n kube-system etcd-kind-control-plane -o=jsonpath={.spec.containers[0].command} | jq .\n\n[\n  \"etcd\",\n  \"--advertise-client-urls=https://172.19.0.2:2379\",\n  \"--cert-file=/etc/kubernetes/pki/etcd/server.crt\",\n  \"--client-cert-auth=true\",\n  \"--data-dir=/var/lib/etcd\",\n  \"--experimental-initial-corrupt-check=true\",\n  \"--experimental-watch-progress-notify-interval=5s\",\n  \"--initial-advertise-peer-urls=https://172.19.0.2:2380\",\n  \"--initial-cluster=kind-control-plane=https://172.19.0.2:2380\",\n  \"--key-file=/etc/kubernetes/pki/etcd/server.key\",\n  \"--listen-client-urls=https://127.0.0.1:2379,https://172.19.0.2:2379\",\n  \"--listen-metrics-urls=http://127.0.0.1:2381\",\n  \"--listen-peer-urls=https://172.19.0.2:2380\",\n  \"--name=kind-control-plane\",\n  \"--peer-cert-file=/etc/kubernetes/pki/etcd/peer.crt\",\n  \"--peer-client-cert-auth=true\",\n  \"--peer-key-file=/etc/kubernetes/pki/etcd/peer.key\",\n  \"--peer-trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt\",\n  \"--snapshot-count=10000\",\n  \"--trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt\"\n]\n--listen-metrics-urls\n ¬†‚Äî —Ç–æ, —á—Ç–æ –º—ã –∏—â–µ–º .\netcd\n –±—É–¥–µ—Ç –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å \n–ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ \nPrometheus –≤ –∫–æ–Ω–µ—á–Ω–æ–π —Ç–æ—á–∫–µ \n/metrics\n –ø–æ —ç—Ç–æ–º—É –∞–¥—Ä–µ—Å—É. –°–æ–∑–¥–∞—ë–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª Prometheus, —á—Ç–æ–±—ã –¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—É —Å–±–æ—Ä—â–∏–∫—É –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ—á–∏—Å—Ç–∫—É \netcd\n.\nprometheus.yml\nglobal:\n  scrape_interval: 1s\nscrape_configs:\n  - job_name: etcd\n    static_configs:\n    - targets: ['127.0.0.1:2379']\n–ü—Ä–µ–∂–¥–µ —á–µ–º –º—ã –∑–∞–ø—É—Å—Ç–∏–º Prometheus, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–æ–Ω–µ—á–Ω–æ–π —Ç–æ—á–∫–µ \netcd metrics\n. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ä—Ç–æ–≤ –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –∏–º–µ–Ω \nhost network\n –ø–æ–∑–≤–æ–ª–∏—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å Prometheus –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ –∏–º–µ–Ω \nhost network\n, —á—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –ø–∞–Ω–µ–ª–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.\n–ü–µ—Ä–µ–Ω–µ—Å–∏—Ç–µ –∫–æ–Ω–µ—á–Ω—É—é —Ç–æ—á–∫—É \netcd metrics\n.\n$ kubectl port-forward -n kube-system pod/etcd-kind-control-plane 2381:2381\n–ó–∞—Ç–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä Prometheus, –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–π –∫ —Å–µ—Ç–∏ —Ö–æ—Å—Ç–∞.  \n$ docker run --net=host --rm -v $(pwd)/prometheus.yml:/etc/prometheus/prometheus.yml prom/prometheus\n–ü–∞–Ω–µ–ª—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ Prometheus —Ç–µ–ø–µ—Ä—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –ø–æ –∞–¥—Ä–µ—Å—É \n127.0.0.1:9090\n. –ú—ã –º–æ–∂–µ–º –ø–æ–ª—É—á–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç \netcd\n, –≤–≤–µ–¥—è –∑–∞–ø—Ä–æ—Å. –ù–∞–ø—Ä–∏–º–µ—Ä, \nirate(process_cpu_seconds_total{job=\"etcd\"}[5m])\n –ø–æ–∫–∞–∂–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å —É–≤–µ–ª–∏—á–µ–Ω–∏—è –æ–±—â–µ–≥–æ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. –ï—Å–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É —Å–µ–π—á–∞—Å, –∫–æ—Ç–æ—Ä–∞—è —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä—ã –¥–ª—è \nConfigMaps\n, –º—ã –Ω–µ —É–≤–∏–¥–∏–º —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤–ª–∏—è–Ω–∏—è –Ω–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä.\n–î–∏–∞–ø–∞–∑–æ–Ω –ø–æ –æ—Å–∏ Y —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç –æ—Ç \n0.03\n –¥–æ \n0.23\n.\n–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:\n –ü–æ—Å–∫–æ–ª—å–∫—É –º—ã –∑–∞–ø—É—Å–∫–∞–µ–º \netcd\n –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ \nkind\n, —Å–µ—Ä–≤–µ—Ä API Kubernetes –∏ –¥—Ä—É–≥–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—Ç —Å –Ω–∏–º –≤ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫ –Ω–∞–≥—Ä—É–∑–∫–µ –æ—Ç –ø—Ä–æ–≥—Ä–∞–º–º—ã.\n–≠—Ç–æ–≥–æ –∏ —Å–ª–µ–¥–æ–≤–∞–ª–æ –æ–∂–∏–¥–∞—Ç—å: –æ–¥–Ω–∏ —á–∞—Å—ã –≤—Ä—è–¥ –ª–∏ –æ–∫–∞–∂—É—Ç —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ. –ù–æ –µ—Å–ª–∏ –º—ã —É–≤–µ–ª–∏—á–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤, —Ç–æ –Ω–∞—á–Ω–µ–º —Å—Ç–∞–ª–∫–∏–≤–∞—Ç—å—Å—è —Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏. –î–∞–≤–∞–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏–º –Ω–∞—à—É –ø—Ä–æ–≥—Ä–∞–º–º—É —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω–∞ –∑–∞–ø—É—Å–∫–∞–ª–∞ 10 000 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –Ω–∞ \nConfigMaps\n.\nmanydirectwatch.go\npackage main\n\nimport (\n\t\"context\"\n\t\"fmt\"\n\t\"os\"\n\t\"os/signal\"\n\n\t\"go.etcd.io/etcd/client/pkg/v3/transport\"\n\tclientv3 \"go.etcd.io/etcd/client/v3\"\n\tv1 \"k8s.io/api/core/v1\"\n\t\"k8s.io/apimachinery/pkg/runtime\"\n\t\"k8s.io/apimachinery/pkg/runtime/serializer\"\n\t\"k8s.io/apiserver/pkg/storage\"\n\t\"k8s.io/apiserver/pkg/storage/etcd3\"\n\t\"k8s.io/apiserver/pkg/storage/value/encrypt/identity\"\n\t\"k8s.io/kubernetes/pkg/apis/core\"\n\tk8sv1 \"k8s.io/kubernetes/pkg/apis/core/v1\"\n)\n\nfunc main() {\n\ttlsConfig, err := (transport.TLSInfo{\n\t\tCertFile:       \"./pki/etcd/server.crt\",\n\t\tKeyFile:        \"./pki/etcd/server.key\",\n\t\tTrustedCAFile:  \"./pki/etcd/ca.crt\",\n\t\tClientCertFile: \"./pki/apiserver-etcd-client.crt\",\n\t\tClientKeyFile:  \"./pki/apiserver-etcd-client.key\",\n\t}).ClientConfig()\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tc, err := clientv3.New(clientv3.Config{\n\t\tEndpoints: []string{\"https://127.0.0.1:2379\"},\n\t\tTLS:       tlsConfig,\n\t})\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\n\tscheme := runtime.NewScheme()\n\tk8sv1.AddToScheme(scheme)\n\tcore.AddToScheme(scheme)\n\tf := serializer.NewCodecFactory(scheme)\n\ts := etcd3.New(c, f.CodecForVersions(nil, f.UniversalDecoder(), nil, k8sv1.SchemeGroupVersion), nil, \"registry\", v1.Resource(\"ConfigMap\"), identity.NewEncryptCheckTransformer(), true, etcd3.NewDefaultLeaseManagerConfig())\n\tfor i := 0; i < 10000; i++ {\n\t\tw, err := s.Watch(context.Background(), \"configmaps\", storage.ListOptions{\n\t\t\tPredicate: storage.Everything,\n\t\t\tRecursive: true,\n\t\t})\n\t\tif err != nil {\n\t\t\tpanic(err)\n\t\t}\n\t\tgo func() {\n\t\t\tfor e := range w.ResultChan() {\n\t\t\t\tco, ok := e.Object.(*v1.ConfigMap)\n\t\t\t\tif !ok {\n\t\t\t\t\tpanic(\"not a config map!\")\n\t\t\t\t}\n\t\t\t\tfmt.Printf(\"%s || %s/%s\\n\", e.Type, co.Namespace, co.Name)\n\t\t\t}\n\t\t}()\n\t}\n\n\tstop := make(chan os.Signal)\n\tsignal.Notify(stop, os.Interrupt)\n\t<-stop\n}\n–ï—Å–ª–∏ –º—ã –∑–∞–ø—É—Å—Ç–∏–º –ø—Ä–æ–≥—Ä–∞–º–º—É —Å–µ–π—á–∞—Å, —Ç–æ –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å, —á—Ç–æ –≤—Å–µ 10 000 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –ø–æ–ª—É—á–∞—é—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö \nConfigMaps\n –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ. –ö–æ–≥–¥–∞ —Å–æ–∑–¥–∞–¥–∏–º –Ω–æ–≤—É—é \nConfigMap\n, –º—ã —Å–º–æ–∂–µ–º —É–≤–∏–¥–µ—Ç—å, —á—Ç–æ –≤—Å–µ —á–∞—Å—ã –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.\n$ go run manysimplewatch.go\n...\nADDED || kube-system/kube-proxy\nADDED || kube-system/kube-root-ca.crt\nADDED || kube-system/kubeadm-config\nADDED || kube-system/kubelet-config\nADDED || local-path-storage/kube-root-ca.crt\nADDED || local-path-storage/local-path-config\nADDED || kube-system/kube-root-ca.crt\nADDED || kube-system/kubeadm-config\nADDED || kube-system/kubelet-config\nADDED || local-path-storage/kube-root-ca.crt\nADDED || local-path-storage/local-path-config\n...\n$ kubectl create configmap testing\nconfigmap/testing created\n...\nADDED || default/testing\nADDED || default/testing\nADDED || default/testing\nADDED || default/testing\nADDED || default/testing\nADDED || default/testing\nADDED || default/testing\nADDED || default/testing\nADDED || default/testing\nADDED || default/testing\n...\n–û–≥–ª—è–¥—ã–≤–∞—è—Å—å –Ω–∞–∑–∞–¥ –Ω–∞ –Ω–∞—à–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ \netcd\n, –º—ã –≤–∏–¥–∏–º –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π —Å–∫–∞—á–æ–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã. –≠—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç –±–µ—Å–ø–æ–∫–æ–π—Å—Ç–≤–æ, –Ω–æ, –≤–æ–∑–º–æ–∂–Ω–æ, –µ—â–µ –±–æ–ª–µ–µ –Ω–µ–ø—Ä–∏—è—Ç–Ω—ã–º —è–≤–ª—è–µ—Ç—Å—è –æ–±—ä–µ–º —Ä–∞–±–æ—Ç—ã, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –ø—Ä–æ–¥–µ–ª–∞–Ω –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π \nConfigMap\n. –ü–æ–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏—Ä—É–µ—Ç—Å—è –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ, —Å–µ—Ä–≤–µ—Ä Kubernetes API –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ –≤ \netcd\n –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–∑ –Ω–∏—Ö –Ω–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, –≤–µ–¥—å —Å–µ—Ä–≤–µ—Ä—É API —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, —á—Ç–æ–±—ã –ø—Ä–æ–∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤.\n–î–∏–∞–ø–∞–∑–æ–Ω –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ –æ—Å–∏ Y —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç –æ—Ç \n0,00\n –¥–æ \n3,00\n.\n–ü–µ—Ä–≤—ã–π –±–æ–ª—å—à–æ–π –≤—Å–ø–ª–µ—Å–∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –º–æ–º–µ–Ω—Ç—É –∑–∞–ø—É—Å–∫–∞ –Ω–∞—à–µ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã. –í—Ç–æ—Ä–æ–π –≤—Å–ø–ª–µ—Å–∫, —Ö–æ—Ç—è –∏ –º–µ–Ω—å—à–∏–π, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å–æ–∑–¥–∞–Ω–∏—é –µ–¥–∏–Ω–æ–π \nConfigMap\n —Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ 10 000 –Ω–∞–±–ª—é–¥–µ–Ω–∏—è–º–∏.\n–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ\n–ö–∞–∫ –≤—ã –¥–æ–≥–∞–¥–∞–ª–∏—Å—å, —Å–µ—Ä–≤–µ—Ä API Kubernetes –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —Ä–µ—à–µ–Ω–∏—è —ç—Ç–æ–π –ø—Ä–æ–±–ª–µ–º—ã, –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å–æ —Å–ª–æ–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –≤–æ –º–Ω–æ–≥–æ–º –ø–æ—Ö–æ–∂–µ –Ω–∞ –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ \netcd3 storage.Interface\n. –§–∞–∫—Ç–∏—á–µ—Å–∫–∏, —É—Ä–æ–≤–µ–Ω—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∞–ª–∏–∑—É–µ—Ç \nstorage.Interface\n —Ç–æ–∂–µ.\n–ü—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ \ncacher.Cacher\n –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ \nConfig\n, –∫–æ—Ç–æ—Ä–∞—è –≤–∫–ª—é—á–∞–µ—Ç –≤ —Å–µ–±—è \nstorage.Interface\n. –ö–∞–∫ —É–∫–∞–∑–∞–Ω–æ –≤ \n—Å—Ç—Ä–æ–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞\n.¬†\n// Cacher implements storage.Interface (although most of the calls are just\n// delegated to the underlying storage).\n–ù–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–∫–æ–ª—å–∫—É \netcd\n –∏–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è –æ —Å–æ–±—ã—Ç–∏—è—Ö —Å–æ–∑–¥–∞–Ω–∏—è (\nADDED\n), \n—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è\n \nCreate() Cacher\n –Ω–∞–ø—Ä—è–º—É—é –≤—ã–∑—ã–≤–∞–µ—Ç \nstorage Create()\n.\n// Create implements storage.Interface.\nfunc (c *Cacher) Create(ctx context.Context, key string, obj, out runtime.Object, ttl uint64) error {\n\treturn c.storage.Create(ctx, key, obj, out, ttl)\n}\n–î—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º –±–∞–∑–æ–≤–æ–≥–æ \nstorage\n, –Ω–æ \nWatch()\n –≤–æ–æ–±—â–µ –Ω–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å –Ω–∏–º –Ω–∞–ø—Ä—è–º—É—é. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –æ–Ω —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π \ncacheWatcher\n –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–≤–æ–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π. –ü—Ä–µ–∂–¥–µ —á–µ–º —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ —Ç–æ–º, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç \ncacheWatcher\n, –Ω—É–∂–Ω–æ –ø–æ–Ω—è—Ç—å, –∫–∞–∫ —Å–æ–±—ã—Ç–∏—è –¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –∏–∑ \netcd\n –≤—Å–µ–º –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è–º, –∑–∞–ø—É—â–µ–Ω–Ω—ã–º —ç—Ç–∏–º –º–µ—Ç–æ–¥–æ–º. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Cacher —Å–æ–∑–¥–∞—é—Ç—Å—è —Ç—Ä–∏ –≤–∞–∂–Ω—ã—Ö –±–∞–∑–æ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞, –¥–≤–∞ –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö ‚Äî —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—â–∏—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ –≤ –ø–∞–∫–µ—Ç–µ \nclient-go cache\n:\nwatchCache\n ‚Äî —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π \ncache.Store\n;\ncacherListerWatcher\n ‚Äî —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π \ncache.ListerWatcher\n;\nReflector\n –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–≤—É—Ö —Ä–∞–Ω–µ–µ —É–ø–æ–º—è–Ω—É—Ç—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ.\n–î–∞–≤–∞–π—Ç–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –∫–∞–∂–¥—ã–π –∏–∑ –Ω–∏—Ö –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ.\nwatchCache\nwatchCache\n ¬†‚Äî –º–µ—Å—Ç–æ, –≥–¥–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∫—ç—à —Å–æ–±—ã—Ç–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è–º. –≠—Ç–æ —Å–∫–æ–ª—å–∑—è—â–µ–µ –æ–∫–Ω–æ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞. –≠—Ç–æ¬† –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –º—ã –ª–∏–±–æ —É–¥–∞–ª—è–µ–º —Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π, –ª–∏–±–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∫—ç—à–∞, —á—Ç–æ–±—ã –≤–º–µ—Å—Ç–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞. –ö–∞–∫ —É–ø–æ–º–∏–Ω–∞–ª–æ—Å—å —Ä–∞–Ω–µ–µ, \nwatchCache\n —Ä–µ–∞–ª–∏–∑—É–µ—Ç \ncache.Store\n, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –º–µ—Ç–æ–¥—ã.  \ntype Store interface {\n\n\t// Add adds the given object to the accumulator associated with the given object's key\n\tAdd(obj interface{}) error\n\n\t// Update updates the given object in the accumulator associated with the given object's key\n\tUpdate(obj interface{}) error\n\n\t// Delete deletes the given object from the accumulator associated with the given object's key\n\tDelete(obj interface{}) error\n\n\t// List returns a list of all the currently non-empty accumulators\n\tList() []interface{}\n\n\t// ListKeys returns a list of all the keys currently associated with non-empty accumulators\n\tListKeys() []string\n\n\t// Get returns the accumulator associated with the given object's key\n\tGet(obj interface{}) (item interface{}, exists bool, err error)\n\n\t// GetByKey returns the accumulator associated with the given key\n\tGetByKey(key string) (item interface{}, exists bool, err error)\n\n\t// Replace will delete the contents of the store, using instead the\n\t// given list. Store takes ownership of the list, you should not reference\n\t// it after calling this function.\n\tReplace([]interface{}, string) error\n\n\t// Resync is meaningless in the terms appearing here but has\n\t// meaning in some implementations that have non-trivial\n\t// additional behavior (e.g., DeltaFIFO).\n\tResync() error\n}\n–†–µ–∞–ª–∏–∑–∞—Ü–∏–∏ \nAdd()\n, \nUpdate()\n, –∏ \nDelete()\n —Å–æ–∑–¥–∞—é—Ç \nwatch.Event\n, –∑–∞—Ç–µ–º –ø–µ—Ä–µ–¥–∞–π—Ç–µ –µ–≥–æ –º–µ—Ç–æ–¥—É \nprocessEvent()\n. –ó–¥–µ—Å—å —Å–æ–±—ã—Ç–∏–µ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç—Å—è –≤ \nwatchCacheEvent\n, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è \nupdateCache()\n. –ú–µ—Ç–æ–¥ \nupdateCache()\n –≤–º–µ—Å—Ç–µ —Å –≤—ã–∑—ã–≤–∞–µ–º—ã–º –∏–º –º–µ—Ç–æ–¥–æ–º \nresizeCacheLocked()\n ‚Äî —ç—Ç–æ —Ç–æ, –≥–¥–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ª–æ–≥–∏–∫–∞ —Å–∫–æ–ª—å–∑—è—â–µ–≥–æ –æ–∫–Ω–∞.\n// Assumes that lock is already held for write.\nfunc (w *watchCache) updateCache(event *watchCacheEvent) {\n\tw.resizeCacheLocked(event.RecordTime)\n\tif w.isCacheFullLocked() {\n\t\t// Cache is full - remove the oldest element.\n\t\tw.startIndex++\n\t}\n\tw.cache[w.endIndex%w.capacity] = event\n\tw.endIndex++\n}\n\n// resizeCacheLocked resizes the cache if necessary:\n// - increases capacity by 2x if cache is full and all cached events occurred within last eventFreshDuration.\n// - decreases capacity by 2x when recent quarter of events occurred outside of eventFreshDuration(protect watchCache from flapping).\nfunc (w *watchCache) resizeCacheLocked(eventTime time.Time) {\n\tif w.isCacheFullLocked() && eventTime.Sub(w.cache[w.startIndex%w.capacity].RecordTime) < eventFreshDuration {\n\t\tcapacity := min(w.capacity*2, w.upperBoundCapacity)\n\t\tif capacity > w.capacity {\n\t\t\tw.doCacheResizeLocked(capacity)\n\t\t}\n\t\treturn\n\t}\n\tif w.isCacheFullLocked() && eventTime.Sub(w.cache[(w.endIndex-w.capacity/4)%w.capacity].RecordTime) > eventFreshDuration {\n\t\tcapacity := max(w.capacity/2, w.lowerBoundCapacity)\n\t\tif capacity < w.capacity {\n\t\t\tw.doCacheResizeLocked(capacity)\n\t\t}\n\t\treturn\n\t}\n}\n–ü–µ—Ä–µ–¥ –≤–æ–∑–≤—Ä–∞—Ç–æ–º –∏–∑ \nprocessEvent()\n –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏—è \neventHandler()\n, –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ –ø–µ—Ä–µ–¥–∞–Ω–∞ –≤–æ –≤—Ä–µ–º—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è \nwatchCache\n. –ú—ã –≤–µ—Ä–Ω–µ–º—Å—è –∫ —ç—Ç–æ–º—É –≤—Å–∫–æ—Ä–µ, –∫–æ–≥–¥–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º, –∫–∞–∫ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–∏ —É–≤–µ–¥–æ–º–ª—è—é—Ç—Å—è –æ —Å–æ–±—ã—Ç–∏—è—Ö.\n// Avoid calling event handler under lock.\n\t// This is safe as long as there is at most one call to Add/Update/Delete and\n\t// UpdateResourceVersion in flight at any point in time, which is true now,\n\t// because reflector calls them synchronously from its main thread.\n\tif w.eventHandler != nil {\n\t\tw.eventHandler(wcEvent)\n\t}\n–î—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã, –æ—Å–æ–±–µ–Ω–Ω–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ –≤–∫–ª—é—á–∞—é—Ç –ø–æ–ª—É—á–µ–Ω–∏–µ –∏ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ, –ø–æ–ª–∞–≥–∞—é—Ç—Å—è –Ω–∞ –±–∞–∑–æ–≤—ã–π \ncache.Indexer\n. –í –∏—Ç–æ–≥–µ \n–ø—Ä–æ—Å—Ç—ã–µ –∏–Ω–¥–µ–∫—Å—ã\n, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –≤ \nwatchCache\n, —Å–≤–æ–¥—è—Ç—Å—è –∫ –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ–π \nmap\n. –í —Ç–æ –≤—Ä–µ–º—è –∫–∞–∫ —Å–∫–æ–ª—å–∑—è—â–µ–µ –æ–∫–Ω–æ —Å–æ–±—ã—Ç–∏–π –≤ \nwatchCache\n –ø–æ–º–æ–≥–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–Ω–æ–≥–∏–º —Ä–∞–∑–ª–∏—á–Ω—ã–º –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è–º, –∏–Ω–¥–µ–∫—Å–∞—Ç–æ—Ä –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–æ–≤—ã–º –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è–º –ª–µ–≥–∫–æ –ø–æ–ª—É—á–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤, —á—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è.\n–í–º–µ—Å—Ç–µ —ç—Ç–∏ –¥–≤–∞ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –æ–±—Å–ª—É–∂–∏–≤–∞—é—Ç –∑–∞–ø—Ä–æ—Å—ã –∏–∑ –∏—Ö —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –≤ –ø–∞–º—è—Ç–∏, –≤–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ \netcd\n –Ω–∞–ø—Ä—è–º—É—é.\ncacherListerWatcher\ncacherListerWatcher\n –Ω–∞–º–Ω–æ–≥–æ –ø—Ä–æ—â–µ, —á–µ–º \nwatchCache\n, —Ç–∞–∫ –∫–∞–∫ –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç \nstorage.Interface\n, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è \nCacher\n –∏ –≤—ã–∑—ã–≤–∞–µ—Ç –±–∞–∑–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã \nGetList()\n –∏ \nWatch()\n.\n// NewCacherListerWatcher returns a storage.Interface backed ListerWatcher.\nfunc NewCacherListerWatcher(storage storage.Interface, resourcePrefix string, newListFunc func() runtime.Object) cache.ListerWatcher {\n\treturn &cacherListerWatcher{\n\t\tstorage:        storage,\n\t\tresourcePrefix: resourcePrefix,\n\t\tnewListFunc:    newListFunc,\n\t}\n}\n\n// Implements cache.ListerWatcher interface.\nfunc (lw *cacherListerWatcher) List(options metav1.ListOptions) (runtime.Object, error) {\n\tlist := lw.newListFunc()\n\tpred := storage.SelectionPredicate{\n\t\tLabel:    labels.Everything(),\n\t\tField:    fields.Everything(),\n\t\tLimit:    options.Limit,\n\t\tContinue: options.Continue,\n\t}\n\n\tstorageOpts := storage.ListOptions{\n\t\tResourceVersionMatch: options.ResourceVersionMatch,\n\t\tPredicate:            pred,\n\t\tRecursive:            true,\n\t}\n\tif err := lw.storage.GetList(context.TODO(), lw.resourcePrefix, storageOpts, list); err != nil {\n\t\treturn nil, err\n\t}\n\treturn list, nil\n}\n\n// Implements cache.ListerWatcher interface.\nfunc (lw *cacherListerWatcher) Watch(options metav1.ListOptions) (watch.Interface, error) {\n\topts := storage.ListOptions{\n\t\tResourceVersion: options.ResourceVersion,\n\t\tPredicate:       storage.Everything,\n\t\tRecursive:       true,\n\t\tProgressNotify:  true,\n\t}\n\treturn lw.storage.Watch(context.TODO(), lw.resourcePrefix, opts)\n}\ncacherListerWatcher\n ‚Äî —Ç–æ, —á—Ç–æ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ \nwatchCache\n. –ù–æ –Ω—É–∂–µ–Ω –º–µ—Ö–∞–Ω–∏–∑–º, —á—Ç–æ–±—ã —Å–≤—è–∑–∞—Ç—å –∏—Ö –≤–º–µ—Å—Ç–µ.\nReflector\nwatchCache\n –∏ \ncacherListerWatcher\n —Å–æ–∑–¥–∞—é—Ç –ø–µ—Ä–µ–¥ \nReflector\n, —á—Ç–æ–±—ã –ø–µ—Ä–µ–¥–∞—Ç—å –∏—Ö –µ–º—É. \nwatchCache := newWatchCache(\n\t\tconfig.KeyFunc, cacher.processEvent, config.GetAttrsFunc, config.Versioner, config.Indexers, config.Clock, config.GroupResource)\n\tlisterWatcher := NewCacherListerWatcher(config.Storage, config.ResourcePrefix, config.NewListFunc)\n\treflectorName := \"storage/cacher.go:\" + config.ResourcePrefix\n\n\treflector := cache.NewNamedReflector(reflectorName, listerWatcher, obj, watchCache, 0)\nReflector\n –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –≤ –ø–∞–∫–µ—Ç–µ \nclient-go/tools/cache\n —Å–æ —Å–ª–µ–¥—É—é—â–µ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π.  \n// Reflector watches a specified resource and causes all changes to be reflected in the given store.\n–ë–æ–ª—å—à–∞—è —á–∞—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ –µ–≥–æ –º–µ—Ç–æ–¥–∞ \nListAndWatch()\n –û–Ω –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ç–æ, —á—Ç–æ —Å–ª–µ–¥—É–µ—Ç –∏–∑ –µ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è: –ø–µ—Ä–µ—á–∏—Å–ª—è–µ—Ç, –∞ –∑–∞—Ç–µ–º –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç. –°–æ–±—ã—Ç–∏—è, –ø–æ—Å—Ç—É–ø–∞—é—â–∏–µ –æ—Ç \nListerWatcher (cacherListerWatcher)\n, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤ \nwatchHandler()\n. –ò–º–µ–Ω–Ω–æ –∑–¥–µ—Å—å –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ \nwatchCache\n.\n\t\tcase watch.Added:\n\t\t\t\terr := store.Add(event.Object)\n\t\t\t\tif err != nil {\n\t\t\t\t\tutilruntime.HandleError(fmt.Errorf(\"%s: unable to add watch event object (%#v) to store: %v\", name, event.Object, err))\n\t\t\t\t}\n\t\t\tcase watch.Modified:\n\t\t\t\terr := store.Update(event.Object)\n\t\t\t\tif err != nil {\n\t\t\t\t\tutilruntime.HandleError(fmt.Errorf(\"%s: unable to update watch event object (%#v) to store: %v\", name, event.Object, err))\n\t\t\t\t}\n\t\t\tcase watch.Deleted:\n\t\t\t\t// TODO: Will any consumers need access to the \"last known\n\t\t\t\t// state\", which is passed in event.Object? If so, may need\n\t\t\t\t// to change this.\n\t\t\t\terr := store.Delete(event.Object)\n\t\t\t\tif err != nil {\n\t\t\t\t\tutilruntime.HandleError(fmt.Errorf(\"%s: unable to delete watch event object (%#v) from store: %v\", name, event.Object, err))\n\t\t\t\t}\n–°–≤—è–∑—ã–≤–∞–µ–º –≤—Å—ë –≤–º–µ—Å—Ç–µ\n–ö–æ–≥–¥–∞ –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–∞ –º–µ—Å—Ç–µ, –ø–æ—Ä–∞ –∑–∞–ø—É—Å—Ç–∏—Ç—å \nReflector\n, —á—Ç–æ–±—ã –∏–∑–≤–ª–µ–∫–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ \ncacherListerWatcher\n –∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∏—Ö –≤ \nwatchCache\n, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å \nCacher\n –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö.  \ngo cacher.dispatchEvents()\n\n\tcacher.stopWg.Add(1)\n\tgo func() {\n\t\tdefer cacher.stopWg.Done()\n\t\tdefer cacher.terminateAllWatchers()\n\t\twait.Until(\n\t\t\tfunc() {\n\t\t\t\tif !cacher.isStopped() {\n\t\t\t\t\tcacher.startCaching(stopCh)\n\t\t\t\t}\n\t\t\t}, time.Second, stopCh,\n\t\t)\n\t}()\n–°–Ω–∞—á–∞–ª–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –≤—Ç–æ—Ä–æ–π –≤—ã–∑–æ–≤, \ncacher.startCaching(stopCh)\n ‚Äî —Ç–∞–∫ –º—ã –∑–∞–ø—É—Å–∫–∞–µ–º \nReflector\n —Å –ø–æ–º–æ—â—å—é –≤—ã–∑–æ–≤–∞ \nListAndWatch()\n.  \nfunc (c *Cacher) startCaching(stopChannel <-chan struct{}) {\n\t// The 'usable' lock is always 'RLock'able when it is safe to use the cache.\n\t// It is safe to use the cache after a successful list until a disconnection.\n\t// We start with usable (write) locked. The below OnReplace function will\n\t// unlock it after a successful list. The below defer will then re-lock\n\t// it when this function exits (always due to disconnection), only if\n\t// we actually got a successful list. This cycle will repeat as needed.\n\tsuccessfulList := false\n\tc.watchCache.SetOnReplace(func() {\n\t\tsuccessfulList = true\n\t\tc.ready.set(true)\n\t\tklog.V(1).Infof(\"cacher (%v): initialized\", c.groupResource.String())\n\t\tmetrics.WatchCacheInitializations.WithLabelValues(c.groupResource.String()).Inc()\n\t})\n\tdefer func() {\n\t\tif successfulList {\n\t\t\tc.ready.set(false)\n\t\t}\n\t}()\n\n\tc.terminateAllWatchers()\n\t// Note that since onReplace may be not called due to errors, we explicitly\n\t// need to retry it on errors under lock.\n\t// Also note that startCaching is called in a loop, so there's no need\n\t// to have another loop here.\n\tif err := c.reflector.ListAndWatch(stopChannel); err != nil {\n\t\tklog.Errorf(\"cacher (%v): unexpected ListAndWatch error: %v; reinitializing...\", c.groupResource.String(), err)\n\t}\n}\n–≠—Ç–æ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ —Ç–æ–º—É, —á—Ç–æ \nReflector\n –Ω–∞—á–Ω–µ—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å \nwatchCache\n, –∫–æ—Ç–æ—Ä—ã–π —É–≤–µ–¥–æ–º–∏—Ç \nCacher\n, —á—Ç–æ–±—ã –æ–Ω –º–æ–≥ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –µ–≥–æ –≤—Å–µ–º –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è–º. –ú–µ—Ç–æ–¥ \ncacher.processEvent()\n –±—ã–ª –ø–µ—Ä–µ–¥–∞–Ω –≤ \nwatchCache\n –∫–∞–∫ \neventHandler()\n, –∫–æ—Ç–æ—Ä—ã–π –º—ã –≤–∏–¥–µ–ª–∏ —Ä–∞–Ω–µ–µ.\nfunc (c *Cacher) processEvent(event *watchCacheEvent) {\n\tif curLen := int64(len(c.incoming)); c.incomingHWM.Update(curLen) {\n\t\t// Monitor if this gets backed up, and how much.\n\t\tklog.V(1).Infof(\"cacher (%v): %v objects queued in incoming channel.\", c.groupResource.String(), curLen)\n\t}\n\tc.incoming <- *event\n}\n–í—Å—ë –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ –∫–∞–Ω–∞–ª—É \nc.incoming\n, –∫–æ—Ç–æ—Ä—ã–π –∑–∞—Ç–µ–º —Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ –º–µ—Ç–æ–¥–µ \ncacher.dispatchEvents()\n, –ø—Ä–µ–∂–¥–µ —á–µ–º –±—ã—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º –∫–∞–∂–¥–æ–º—É –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—é.\n\tcase event, ok := <-c.incoming:\n\t\t\tif !ok {\n\t\t\t\treturn\n\t\t\t}\n\t\t\t// Don't dispatch bookmarks coming from the storage layer.\n\t\t\t// They can be very frequent (even to the level of subseconds)\n\t\t\t// to allow efficient watch resumption on kube-apiserver restarts,\n\t\t\t// and propagating them down may overload the whole system.\n\t\t\t//\n\t\t\t// TODO: If at some point we decide the performance and scalability\n\t\t\t// footprint is acceptable, this is the place to hook them in.\n\t\t\t// However, we then need to check if this was called as a result\n\t\t\t// of a bookmark event or regular Add/Update/Delete operation by\n\t\t\t// checking if resourceVersion here has changed.\n\t\t\tif event.Type != watch.Bookmark {\n\t\t\t\tc.dispatchEvent(&event)\n\t\t\t}\n\t\t\tlastProcessedResourceVersion = event.ResourceVersion\n\t\t\tmetrics.EventsCounter.WithLabelValues(c.groupResource.String()).Inc()\n–ö–æ–≥–¥–∞ –º—ã –≤—ã–∑—ã–≤–∞–µ–º \nc.dispatchEvent(&event)\n, —Å–ø–∏—Å–æ–∫ \ncacheWatcher\n —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç—Å—è –ø–æ —Ç–µ–º, –∫—Ç–æ –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω –≤ –¥–∞–Ω–Ω–æ–º —Å–æ–±—ã—Ç–∏–∏, –∏ —Å–æ–±—ã—Ç–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥–æ–º—É.  \n–ú–µ—Ç–æ–¥ Watch()\n–≠—Ç–æ –±—ã–ª–æ –Ω–µ–ø—Ä–æ—Å—Ç–æ, –Ω–æ —Ç–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ –º—ã –∑–Ω–∞–µ–º, –∫–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Å–æ–±—ã—Ç–∏—è, –ø—Ä–∏—à–ª–æ –≤—Ä–µ–º—è –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –º–µ—Ç–æ–¥—É \nWatch()\n. –í–º–µ—Å—Ç–æ –∑–∞–ø—É—Å–∫–∞ –Ω–æ–≤–æ–≥–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è \netcd\n –ø—Ä–∏ –≤—ã–∑–æ–≤–µ —ç—Ç–æ–≥–æ –º–µ—Ç–æ–¥–∞, —Å–æ–∑–¥–∞–µ–º \ncacheWatcher\n, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º, –∫–æ–≥–¥–∞ \nCacher\n –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è. –ö–∞–∂–¥—ã–π \ncacheWatcher\n –∏–º–µ–µ—Ç —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏: \nwatcher.processInterval()\n. –ú–µ—Ç–æ–¥\n Watch()\n –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–ª—è –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π –æ–Ω —Å–æ–∑–¥–∞–µ—Ç –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –µ–≥–æ –≤ —Å–ø–∏—Å–æ–∫ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–µ–π –¥–ª—è \nCacher\n.\nfunc() {\n\t\tc.Lock()\n\t\tdefer c.Unlock()\n\t\t// Update watcher.forget function once we can compute it.\n\t\twatcher.forget = forgetWatcher(c, watcher, c.watcherIdx, triggerValue, triggerSupported)\n\t\tc.watchers.addWatcher(watcher, c.watcherIdx, triggerValue, triggerSupported)\n\n\t\t// Add it to the queue only when the client support watch bookmarks.\n\t\tif watcher.allowWatchBookmarks {\n\t\t\tc.bookmarkWatchers.addWatcher(watcher)\n\t\t}\n\t\tc.watcherIdx++\n\t}()\n\n\tgo watcher.processInterval(ctx, cacheInterval, watchRV)\n\treturn watcher, nil\ncacheInterval\n —Å–æ–∑–¥–∞–µ—Ç—Å—è \n—Ä–∞–Ω–µ–µ –≤ –º–µ—Ç–æ–¥–µ\n \n–∏ –¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ª—é–±—ã–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–æ–±—ã—Ç–∏—è –≤ \nwatchCache\n, –∫–æ—Ç–æ—Ä—ã–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç \ncacheWatcher\n. –ú–µ—Ç–æ–¥ \nwatcher.processInterval()\n —Å–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –∏–∑ \ncacheInterval\n, –∑–∞—Ç–µ–º –Ω–∞—á–∏–Ω–∞–µ—Ç –æ–∂–∏–¥–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±—É–¥—É—â–∏—Ö \n–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π\n.\n\tfor {\n\t\tevent, err := cacheInterval.Next()\n\t\tif err != nil {\n\t\t\tklog.Warningf(\"couldn't retrieve watch event to serve: %#v\", err)\n\t\t\treturn\n\t\t}\n\t\tif event == nil {\n\t\t\tbreak\n\t\t}\n\t\tc.sendWatchCacheEvent(event)\n\t\t// With some events already sent, update resourceVersion so that\n\t\t// events that were buffered and not yet processed won't be delivered\n\t\t// to this watcher second time causing going back in time.\n\t\tresourceVersion = event.ResourceVersion\n\t\tinitEventCount++\n\t}\n–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ\n: –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –∫–æ–¥—É —É–¥–∞–ª–µ–Ω—ã –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏.\n–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –≤—ã–∑–æ–≤–∞ —Ñ—É–Ω–∫—Ü–∏–∏ \nsendWatchCacheEvent()\n, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –µ–≥–æ. –ó–∞—Ç–µ–º –¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ –∫–∞–Ω–∞–ª—É result, –∫–æ—Ç–æ—Ä—ã–π —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Ç–µ–º –∂–µ –∫–∞–Ω–∞–ª–æ–º, –∏–∑ –∫–æ—Ç–æ—Ä–æ–≥–æ –≤—ã–∑—ã–≤–∞—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏—é \nWatch()\n –º–æ–≥—É—Ç —Å—á–∏—Ç—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ!\nfunc (c *cacheWatcher) sendWatchCacheEvent(event *watchCacheEvent) {\n\twatchEvent := c.convertToWatchEvent(event)\n\tif watchEvent == nil {\n\t\t// Watcher is not interested in that object.\n\t\treturn\n\t}\n\n\tselect {\n\tcase <-c.done:\n\t\treturn\n\tdefault:\n\t}\n\n\tselect {\n\tcase c.result <- *watchEvent:\n\tcase <-c.done:\n\t}\n}\n–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ\n: –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –∫–æ–¥—É —É–¥–∞–ª–µ–Ω—ã –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏.\n–í—Å–µ —Å–º–æ—Ç—Ä—è—Ç‚Ä¶ –ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ  \n–î–∞–≤–∞–π—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–∏–º –Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é¬†\nCacher storage.Interface\n –≤ –¥–µ–π—Å—Ç–≤–∏–∏. –ú—ã –±–µ—Ä—ë–º –Ω–∞—à—É –ø—Ä–æ–≥—Ä–∞–º–º—É –∏ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –µ—ë, —á—Ç–æ–±—ã –ø–µ—Ä–µ–¥–∞—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ \netcd Cacher\n.\ncachewatch.go\npackage main\n\nimport (\n\t\"context\"\n\t\"fmt\"\n\t\"os\"\n\t\"os/signal\"\n\n\t\"go.etcd.io/etcd/client/pkg/v3/transport\"\n\tclientv3 \"go.etcd.io/etcd/client/v3\"\n\tv1 \"k8s.io/api/core/v1\"\n\t\"k8s.io/apimachinery/pkg/fields\"\n\t\"k8s.io/apimachinery/pkg/labels\"\n\t\"k8s.io/apimachinery/pkg/runtime\"\n\t\"k8s.io/apimachinery/pkg/runtime/serializer\"\n\t\"k8s.io/apiserver/pkg/storage\"\n\t\"k8s.io/apiserver/pkg/storage/cacher\"\n\t\"k8s.io/apiserver/pkg/storage/etcd3\"\n\t\"k8s.io/apiserver/pkg/storage/value/encrypt/identity\"\n\t\"k8s.io/kubernetes/pkg/apis/core\"\n\tk8sv1 \"k8s.io/kubernetes/pkg/apis/core/v1\"\n\t\"k8s.io/utils/clock\"\n)\n\nfunc main() {\n\ttlsConfig, err := (transport.TLSInfo{\n\t\tCertFile:       \"./pki/etcd/server.crt\",\n\t\tKeyFile:        \"./pki/etcd/server.key\",\n\t\tTrustedCAFile:  \"./pki/etcd/ca.crt\",\n\t\tClientCertFile: \"./pki/apiserver-etcd-client.crt\",\n\t\tClientKeyFile:  \"./pki/apiserver-etcd-client.key\",\n\t}).ClientConfig()\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tc, err := clientv3.New(clientv3.Config{\n\t\tEndpoints: []string{\"https://127.0.0.1:2379\"},\n\t\tTLS:       tlsConfig,\n\t})\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\n\tscheme := runtime.NewScheme()\n\tk8sv1.AddToScheme(scheme)\n\tcore.AddToScheme(scheme)\n\tf := serializer.NewCodecFactory(scheme)\n\ts := etcd3.New(c, f.CodecForVersions(nil, f.UniversalDecoder(), nil, k8sv1.SchemeGroupVersion), nil, \"registry\", v1.Resource(\"ConfigMap\"), identity.NewEncryptCheckTransformer(), true, etcd3.NewDefaultLeaseManagerConfig())\n\n\tca, err := cacher.NewCacherFromConfig(cacher.Config{\n\t\tStorage:        s,\n\t\tVersioner:      storage.APIObjectVersioner{},\n\t\tGroupResource:  v1.Resource(\"configmaps\"),\n\t\tResourcePrefix: \"configmaps\",\n\t\tKeyFunc:        func(o runtime.Object) (string, error) { return storage.NamespaceKeyFunc(\"configmaps\", o) },\n\t\tGetAttrsFunc: func(o runtime.Object) (label labels.Set, field fields.Set, err error) {\n\t\t\treturn labels.Set{},\n\t\t\t\tfields.Set{}, nil\n\t\t},\n\t\tNewFunc: func() runtime.Object {\n\t\t\treturn &v1.ConfigMap{}\n\t\t},\n\t\tNewListFunc: func() runtime.Object {\n\t\t\treturn &v1.ConfigMapList{}\n\t\t},\n\t\tCodec: f.LegacyCodec(k8sv1.SchemeGroupVersion),\n\t\tClock: clock.RealClock{},\n\t})\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tfor i := 0; i < 10000; i++ {\n\t\tw, err := ca.Watch(context.Background(), \"configmaps\", storage.ListOptions{\n\t\t\tPredicate: storage.Everything,\n\t\t\tRecursive: true,\n\t\t})\n\t\tif err != nil {\n\t\t\tpanic(err)\n\t\t}\n\t\tgo func() {\n\t\t\tfor e := range w.ResultChan() {\n\t\t\t\tswitch o := e.Object.(type) {\n\t\t\t\tcase *v1.ConfigMap:\n\t\t\t\t\tfmt.Printf(\"%s || %s/%s\\n\", e.Type, o.Namespace, o.Name)\n\t\t\t\tdefault:\n\t\t\t\t\tco, ok := o.(runtime.CacheableObject)\n\t\t\t\t\tif !ok {\n\t\t\t\t\t\tpanic(\"unknown event\")\n\t\t\t\t\t}\n\t\t\t\t\tc, ok := co.GetObject().(*v1.ConfigMap)\n\t\t\t\t\tif !ok {\n\t\t\t\t\t\tpanic(\"unknown object\")\n\t\t\t\t\t}\n\t\t\t\t\tfmt.Printf(\"%s || %s/%s\\n\", e.Type, c.Namespace, c.Name)\n\t\t\t\t}\n\t\t\t}\n\t\t}()\n\t}\n\n\tstop := make(chan os.Signal)\n\tsignal.Notify(stop, os.Interrupt)\n\t<-stop\n}\n–ü–æ—Å–∫–æ–ª—å–∫—É \nPrometheus\n –≤—Å–µ –µ—â–µ –∑–∞–ø—É—â–µ–Ω –∏ –æ—á–∏—â–∞–µ—Ç –Ω–∞—à —ç–∫–∑–µ–º–ø–ª—è—Ä \netcd\n –≤ –Ω–∞—à–µ–º –∫–ª–∞—Å—Ç–µ—Ä–µ \nkind\n, –º—ã –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–∞—à—É –ø—Ä–æ–≥—Ä–∞–º–º—É –∏ –≤–∏–¥–∏–º –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä.  \n$ go run cachewatch.go\n...\nADDED || kube-system/kube-proxy\nADDED || kube-public/cluster-info\nADDED || kube-system/coredns\nADDED || default/kube-root-ca.crt\nADDED || kube-public/kube-root-ca.crt\nADDED || kube-system/kubelet-config\nADDED || kube-system/kubeadm-config\nADDED || kube-system/kubeadm-config\nADDED || local-path-storage/kube-root-ca.crt\nADDED || local-path-storage/local-path-config\nADDED || default/kube-root-ca.crt\n...\n–•–æ—Ç—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ 10 000 –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–µ–π, –≤ –Ω–∞—à–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä–µ \netcd\n –Ω–µ—Ç –∑–∞–º–µ—Ç–Ω–æ–≥–æ –≤–ª–∏—è–Ω–∏—è –Ω–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä. –¢–æ –∂–µ —Å–∞–º–æ–µ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ, –µ—Å–ª–∏ –º—ã —Å–æ–∑–¥–∞–¥–∏–º –Ω–æ–≤—É—é \nConfigMap\n.  \n$ kubectl create configmap testing\nconfigmap/testing created\n...\nADDED || default/testing2\nADDED || default/testing2\nADDED || default/testing2\nADDED || default/testing2\nADDED || default/testing2\nADDED || default/testing2\nADDED || default/testing2\nADDED || default/testing2\nADDED || default/testing2\n...\n–î–∏–∞–ø–∞–∑–æ–Ω –æ—Å–∏\n \nY¬†\n0.00\n–¥–æ¬†\n0.18\n.\n  \n–ó–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã–µ –º—ã—Å–ª–∏\n–≠—Ç–æ –±—ã–ª–∞ –≤—Ç–æ—Ä–∞—è —á–∞—Å—Ç—å —Å–µ—Ä–∏–∏ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–π \n—Å–µ—Ä–≤–µ—Ä–∞ Kubernetes API\n. –û—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –Ω–∞—à–µ–º storage.Interface, –º—ã —É–∑–Ω–∞–ª–∏, –∫–∞–∫ Kubernetes –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É watch –ø–µ—Ä–µ–¥ –ª–∏—Ü–æ–º –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤. –ö–∞–∫ –∏ –≤ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Å–ª—É—á–∞–µ–≤ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è, —ç—Ç–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –Ω–µ –ª–∏—à–µ–Ω–∞ –∫–æ–º–ø—Ä–æ–º–∏—Å—Å–æ–≤, –Ω–æ –æ–Ω–∞ –¥–æ—Å—Ç–∏–≥–∞–µ—Ç —Ü–µ–ª–∏ —Å–¥–µ–ª–∞—Ç—å –æ–±—â–∏–π —Å–ª—É—á–∞–π –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º. –í \n¬´Kubernetes: –ú–µ–≥–∞¬ª\n \n–º—ã —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º –∏ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ–º —Ç–∞–∫–∏–µ –æ–±–ª–∞—Å—Ç–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –∫–∞–∂–¥–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å –∫–æ–º–ø–∞–Ω–∏–∏ —Å—ç–∫–æ–Ω–æ–º–∏—Ç—å —Å–æ—Ç–Ω–∏ —Ç—ã—Å—è—á —Ä—É–±–ª–µ–π.\nhttps://slurm.club/3KhyGtd\n–ú—ã –ø–æ—Å–º–æ—Ç—Ä–∏–º, –µ—Å—Ç—å –ª–∏ –∫–∞–∫–∏–µ-–ª–∏–±–æ —Å–ª—É—á–∞–∏, –∫–æ–≥–¥–∞ —ç—Ç–æ—Ç –∫–æ–º–ø—Ä–æ–º–∏—Å—Å –≤—ã–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã, –≤ –±—É–¥—É—â–∏—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏—è—Ö.\n \n ",
    "tags": [
        "network",
        "kubernetes",
        "k8s",
        "slurm",
        "it-–∫–æ–º–ø–∞–Ω–∏–∏",
        "it-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞",
        "–∫–∞—Ä—å–µ—Ä–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞",
        "–∫–∞—Ä—å–µ—Ä–∞ –∏—Ç-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞"
    ]
}