{
    "article_id": "726348",
    "article_name": "–û–± –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –∑–∞–¥–∞—á–∞—Ö –ø–æ SQL",
    "content": "    –í—Å–µ–º –¥–æ–±—Ä–æ–≥–æ –¥–Ω—è!\n–°—Ç–∞–ª –∏—Å–∫–∞—Ç—å –∑–∞–¥–∞—á–∏ –ø–æ SQL, —á—Ç–æ–±—ã –æ—Å–≤–µ–∂–∏—Ç—å —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è, –∏ –∫ –Ω–µ–º–∞–ª–æ–º—É —É–¥–∏–≤–ª–µ–Ω–∏—é –æ–±–Ω–∞—Ä—É–∂–∏–ª, —á—Ç–æ, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –æ—á–µ–≤–∏–¥–Ω—É—é –≤–æ—Å—Ç—Ä–µ–±–æ–≤–∞–Ω–Ω–æ—Å—Ç—å —Ç–µ–º—ã, –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –Ω–∞–±–æ—Ä—ã –∑–∞–¥–∞—á –Ω–∞ —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–∞—Ö –º–æ–∂–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –ø–æ –ø–∞–ª—å—Ü–∞–º. –•–æ—á—É –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Å —Å–æ–æ–±—â–µ—Å—Ç–≤–æ–º —Å–≤–æ–∏–º –º–Ω–µ–Ω–∏–µ–º –ø–æ –ø–æ–≤–æ–¥—É —ç—Ç–∏—Ö –Ω–∞–±–æ—Ä–æ–≤, —Ç–µ–º –±–æ–ª–µ–µ —á—Ç–æ –≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç —Å–∞–º–∏—Ö –∑–∞–¥–∞—á –¥–∞–ª–µ–∫–æ –Ω–µ –≤—Å–µ –∏—Ö –∞–≤—Ç–æ—Ä—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è –º–Ω–µ –ø–æ–Ω—Ä–∞–≤–∏–ª–∏—Å—å.\n–ü–µ—Ä–≤—ã–π –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –Ω–∞–±–æ—Ä –∑–∞–¥–∞—á —è –Ω–∞—à—ë–ª, –∫–æ–Ω–µ—á–Ω–æ –∂–µ, –Ω–∞ –•–∞–±—Ä–µ üòä ‚Äì \n—ç—Ç–æ—Ç –ø–æ—Å—Ç\n. –ê–≤—Ç–æ—Ä –±–µ–∑—É—Å–ª–æ–≤–Ω–æ ‚Äì –º–æ–ª–æ–¥–µ—Ü, –ø—Ä–æ–¥–µ–ª–∞–ª –±–æ–ª—å—à—É—é —Ä–∞–±–æ—Ç—É! –ù–æ –ø—Ä–∏ –≤—Å–µ—Ö –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—è—Ö –Ω—É–∂–Ω–æ –æ—Ç–º–µ—Ç–∏—Ç—å, —á—Ç–æ —á–∞—Å—Ç–µ–Ω—å–∫–æ –µ–≥–æ –ø–æ–¥—Ö–æ–¥ –∫ —Ä–µ—à–µ–Ω–∏—é –∑–∞–¥–∞—á –±—ã–ª –æ–¥–Ω–æ–±–æ–∫–∏–º ‚Äì –∞–≤—Ç–æ—Ä –≤–µ–∑–¥–µ –≥–¥–µ –Ω–∞–¥–æ –∏ –≥–¥–µ –Ω–µ –Ω–∞–¥–æ –ø—Ä–∏–º–µ–Ω—è–ª join, –∑–∞–±—ã–≤–∞—è –ø—Ä–æ –¥—Ä—É–≥–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —è–∑—ã–∫–∞ (–æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, union, except (–∏–ª–∏ minus)), –≤—Å–ª–µ–¥—Å—Ç–≤–∏–µ —á–µ–≥–æ —Ä–µ—à–µ–Ω–∏—è –ø–æ–ª—É—á–∞–ª–∏—Å—å –≥—Ä–æ–º–æ–∑–¥–∫–∏–º–∏ –∏ –Ω–µ–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ ‚Äì —Ç–∞–∫–∏–º–∏, —á—Ç–æ —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü –±—É–¥–µ—à—å —Å —Ç—Ä—É–¥–æ–º –≤—Å–ø–æ–º–∏–Ω–∞—Ç—å, —á—Ç–æ –∂–µ —Ç—ã –∏–º–µ–ª –≤–≤–∏–¥—É, –∫–æ–≥–¥–∞ –ø–∏—Å–∞–ª –∫–æ–¥:\n 1.1. –î–ª—è —Ä–µ—à–µ–Ω–∏—è –ø–µ—Ä–≤–æ–π –∑–∞–¥–∞—á–∏ (–Ω–∞–π—Ç–∏ –µ–∂–µ–º–µ—Å—è—á–Ω–æ–µ –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –º–µ—Å—è—á–Ω–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π) –∞–≤—Ç–æ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª join, –∞ –Ω—É–∂–Ω–æ –±—ã–ª–æ –±—ã –≤—Å–ø–æ–º–Ω–∏—Ç—å –ø—Ä–æ –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ lag –∏–ª–∏ lead, –∫–æ—Ç–æ—Ä—ã–µ –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –∫–∞–∫–æ–π-–ª–∏–±–æ –≤–µ–ª–∏—á–∏–Ω—ã. –ò—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –≥–æ—Ä–∞–∑–¥–æ –ø–æ–Ω—è—Ç–Ω–µ–µ –∏ –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ:\nwith Per_month_users_count as      (select count(distinct user_id)      as users_count,              date(date, 'start of month') as month_id      from logins      group by month_id)\nselect 100.*(1-(1./users_count)*Lag(users_count) over (order by month_id)),        strftime('%m-%Y', month_id) from Per_month_users_count\n(–°–Ω–∞—á–∞–ª–∞ –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –º–µ—Å—è—Ü–∞–º –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —á–∏—Å–ª–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –∫–∞–∂–¥—ã–π –º–µ—Å—è—Ü, –∞ –ø–æ—Ç–æ–º, –∏—Å–ø–æ–ª—å–∑—É—è –æ–∫–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é lag, –Ω–∞—Ö–æ–¥–∏–º –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—é –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –º–µ—Å—è—Ü—É.\n –†–µ—à–µ–Ω–∏–µ –¥–∞–Ω–æ –ø–æ–¥ SQLite, –Ω–æ —Å—É—Ç–∏ –Ω–µ —ç—Ç–æ –Ω–µ –º–µ–Ω—è–µ—Ç).\n 1.2. –†–µ—à–∞—è –≤—Ç–æ—Ä—É—é –∑–∞–¥–∞—á—É  (–º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏ –¥—Ä–µ–≤–æ–≤–∏–¥–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã), –∞–≤—Ç–æ—Ä —Ç–æ–∂–µ –ø–æ—à—ë–ª –Ω–µ–Ω—É–∂–Ω–æ —Å–ª–æ–∂–Ω—ã–º –ø—É—Ç—ë–º (—Ç–∞–º –∏ join, –∏ group by —Å count, –∏ case when). –ê —Å—Ç–æ–∏–ª–æ –±—ã –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏—Å–º–æ—Ç—Ä–µ—Ç—å—Å—è –∫ —Å–∞–º–æ–π –∏—Å—Ö–æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ ‚Äì –æ–Ω–∞ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–∫, —á—Ç–æ —É–∑–ª—ã –æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç–æ —Ä–∞–∑–±–∏—Ç—å –Ω–∞ –∏—Å–∫–æ–º—ã–µ –∫–ª–∞—Å—Å—ã (–∫–æ—Ä–µ–Ω—å, –ª–∏—Å—Ç—ã, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —É–∑–ª—ã) ‚Äì –≤  —Å—Ç–æ–ª–±—Ü–µ parent –º–æ–≥—É—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —É–∑–ª—ã –∏ –∫–æ—Ä–µ–Ω—å, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –≤—Å–µ—Ö –ª–∏—Å—Ç–æ–≤ —Ä–∞–≤–Ω–æ —Ä–∞–∑–Ω–æ—Å—Ç–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —É–∑–ª–æ–≤, –Ω–∞—Ö–æ–¥—è—â–∏—Ö—Å—è –≤ —Å—Ç–æ–ª–±—Ü–µ node, –∏ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —É–∑–ª–æ–≤, –Ω–∞—Ö–æ–¥—è—â–∏—Ö—Å—è –≤ —Å—Ç–æ–ª–±—Ü–µ parent.\n –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ, –≤–º–µ—Å—Ç–æ join, group by —Å count, –∏ case when –∑–¥–µ—Å—å –≥–æ—Ä–∞–∑–¥–æ –ª–æ–≥–∏—á–Ω–µ–µ –∏ –ø—Ä–æ—â–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å union –∏ except (–∏–ª–∏ minus ‚Äì –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –°–£–ë–î):\nwith Root(id) as\n      (select node from tree\n       where parent is null), \n     Inner_nodes(id) as\n      (select  distinct parent\n       from tree\n       where parent is not null\n       except\n       select * from Root), \n    Leafs(id) as\n     (select node from tree\n      except\n      select * from Inner_nodes\n      except\n      select * from Root)\nselect id, 'Root'  from Root\n union\n select id, 'Inner' from Inner_nodes\n union\n select id, 'Leaf'  from Leafs\n order by id\n(—Ä–µ—à–µ–Ω–∏–µ –¥–∞–Ω–æ –ø–æ–¥ sqlite).\n    1.3. 3-—é —á–∞—Å—Ç—å 3-–π –∑–∞–¥–∞—á–∏ (–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ —Ä–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã –≤ –ø—Ä–æ—à–ª–æ–º) –∞–≤—Ç–æ—Ä –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–ª –∫–∞–∫ –æ—Å–æ–±–µ–Ω–Ω–æ —Å–ª–æ–∂–Ω—É—é (¬´–±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—É—é,  —á–µ–º –≤–∞–º –ø—Ä–µ–¥–ª–æ–∂–∞—Ç –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏¬ª), –∏ –¥–∞–ª –∑—É–±–æ–¥—Ä–æ–±–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ. –ù–æ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Ç–æ –æ—Å–æ–±–æ–π –Ω–µ—Ç,  –ø—Ä–æ—Å—Ç–æ –æ–ø—è—Ç—å –Ω–∞–¥–æ –≤—Å–ø–æ–º–Ω–∏—Ç—å –ø—Ä–æ –æ–∫–Ω–∞ üòä ‚Äì –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è ¬´–¥—ã—Ä—ã¬ª –≤ –ø–æ—Å–µ—â–µ–Ω–∏—è—Ö —Å–∞–π—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç —Ñ—É–Ω–∫—Ü–∏—è lead:\nwith current_users(id, date) as                                                     (select l1.id, l1.date from logins as l1\n      inner join logins as l2\n      on  l1.id = l2.id and                                                              date(l2.date, 'start of month') = date('now', 'start of month')\n --–≤—ã–±–∏—Ä–∞–µ–º –∏–∑ —Ç–∞–±–ª–∏—Ü—ã logins –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –∏ –¥–∞—Ç—ã –≤–∏–∑–∏—Ç–æ–≤ —Ç–æ–ª—å–∫–æ ¬´–∞–∫—Ç–∏–≤–Ω—ã—Ö¬ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Ç–µ—Ö, –∫—Ç–æ –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω –≤ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü)\nselect  id,\n         date      as user_timeout_start,\n         next_date as user_timeout_end\n from\n (select id,\n         date,\n         lead(date) over(partition by id order by date) as next_date\n from current_users)\n where date(date, 'start of month') = date(next_date, 'start of month',\n                                           '-1 days', 'start of month',\n                                           '-1 days', 'start of month')\n--–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ—Ö ¬´–∞–∫—Ç–∏–≤–Ω—ã—Ö¬ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –≤ –∫–∞–∫–æ–π-–ª–∏–±–æ –∏–∑ –º–µ—Å—è—Ü–µ–≤ –Ω–µ –ø–æ—Å–µ—â–∞–ª–∏ —Å–∞–π—Ç (—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å ¬´–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º–∏¬ª).                                                                                                                                                  \n     1.4. –î–ª—è —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ 6 –∞–≤—Ç–æ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª join –∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É, –∞ –≤–Ω–æ–≤—å —Å—Ç–æ–∏–ª–æ –±—ã –≤—Å–ø–æ–º–Ω–∏—Ç—å –ø—Ä–æ –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ üòä:\nselect id,\n         round((julianday(response_timestamp) - julianday(timestamp)) * 86400)             as response_time\n from\n (select id,\n         to_,\n         timestamp,\n         min(case when from_ = 'zach@g.com' then timestamp\n             else  null end) over(partition by subject order by timestamp rows                                   between 1 following and unbounded following)                as response_timestamp\n from Emails)\n where to_ = 'zach@g.com'\n order by id\n –ò—Å–ø–æ–ª—å–∑—É–µ–º min, –∫–∞–∫ –æ–∫–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é, –ø–æ–¥–∞–≤–∞—è –Ω–∞ –µ—ë –≤—Ö–æ–¥ —Ç–æ–ª—å–∫–æ —Ç–µ timestamp, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Å—Ç—Ä–æ–∫–∞–º —Å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–º 'zach@g.com'. –í –∫–∞—á–µ—Å—Ç–≤–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ —Å—Ç—Ä–æ–∫ –æ–∫–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω, –Ω–∞—á–∏–Ω–∞—è —Å–æ —Å—Ç—Ä–æ–∫–∏, —Å–ª–µ–¥—É—é—â–µ–π –∑–∞ —Ç–µ–∫—É—â–µ–π.\n 1.5. 3-—é –∑–∞–¥–∞—á—É –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ ¬´–î—Ä—É–≥–∏–µ –∑–∞–¥–∞—á–∏ —Å—Ä–µ–¥–Ω–µ–π –∏ –≤—ã—Å–æ–∫–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏¬ª –∞–≤—Ç–æ—Ä –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç, –∫–∞–∫ –µ—â—ë –æ–¥–Ω—É –∑–∞–¥–∞—á—É –ø–æ–≤—ã—à–µ–Ω–Ω–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏. –ù–æ —Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω—ã–º –∑–¥–µ—Å—å —è–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ–¥—Ö–æ–¥ –∞–≤—Ç–æ—Ä–∞ –∫ —Ä–µ—à–µ–Ω–∏—é. –ê —Å–∞–º–æ–µ –ø–µ—á–∞–ª—å–Ω–æ–µ, —á—Ç–æ –∞–≤—Ç–æ—Ä –Ω–µ –æ–±—Ä–∞—â–∞–µ—Ç –≤–Ω–∏–º–∞–Ω–∏–µ, —á—Ç–æ –µ–≥–æ –ø–æ–¥—Ö–æ–¥ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–º ‚Äì –µ—Å–ª–∏ –¥–æ–±–∞–≤–∏—Ç—Å—è –µ—â—ë –æ–¥–∏–Ω –∫–ª–∞—Å—Å, —Ç–æ –≤—Å—ë, —Ä–µ—à–µ–Ω–∏–µ –º–æ–∂–Ω–æ –≤—ã–∫–∏–¥—ã–≤–∞—Ç—å. –°—Ç—Ä–∞–Ω–Ω–æ, —á—Ç–æ –∞–≤—Ç–æ—Ä –Ω–µ –≤–∏–¥–∏—Ç –ª–µ–∂–∞—â–µ–µ, –ø—Ä—è–º–æ —Å–∫–∞–∂–µ–º, –Ω–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –∫–æ–Ω–¥–æ–≤–æ–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ ‚Äì –¥–æ–±–∞–≤–∏—Ç—å  —Ç–∞–±–ª–∏—Ü—É, –≤ –∫–æ—Ç–æ—Ä–æ–π –ø—Ä–∏–≤–µ—Å—Ç–∏ –≤–µ–ª–∏—á–∏–Ω—É –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –∫–∞–∂–¥–æ–≥–æ –∫–ª–∞—Å—Å–∞ classes_priorities:\nclass\npriority\na\n1\nb\n2\nc\n3\n    –¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—Å–∞—Ç—å  —Ç—Ä–µ–±—É–µ–º—ã–π –∑–∞–ø—Ä–æ—Å —Å–æ–≤—Å–µ–º –Ω–µ —Å–ª–æ–∂–Ω–æ, –ø–ª—é—Å –æ–Ω –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–∏ –ª—é–±–æ–º —á–∏—Å–ª–µ –∫–ª–∞—Å—Å–æ–≤.\n \nselect fact_class, count(fact_class)\n from\n (select max(t2.priority), t2.class as fact_class\n from users t1\n inner join classes t2\n on t1.class = t2.class\n group by t1.user)\n group by fact_class.\n    –ù–æ –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ –∞–≤—Ç–æ—Ä—É –≤—ã—à–µ–æ–ø–∏—Å–∞–Ω–Ω–æ–π –ø–æ–¥–±–æ—Ä–∫–∏ –∑–∞–¥–∞—á –±–æ–ª—å—à–æ–µ —Å–ø–∞—Å–∏–±–æ –∑–∞ –µ—ë —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ!\n    –í—Ç–æ—Ä–∞—è —Ö–æ—Ä–æ—à–∞—è –ø–æ–¥–±–æ—Ä–∫–∞ –∑–∞–¥–∞—á –µ—Å—Ç—å –Ω–∞ \nuproger.com\n: \nhttps://uproger.com/zadachi-sql-s-resheniyami-dvadczat-pyat-prakticheskih-uprazhnenij-sql/\n.\n   –°—É–¥—è –ø–æ –≤—Å–µ–º—É, –æ–Ω–∞ —Ç–æ–∂–µ –ø–µ—Ä–µ–≤–æ–¥–Ω–∞—è, –Ω–æ —Å—Å—ã–ª–∫–∏ –Ω–∞ –∏—Å—Ö–æ–¥–Ω—É—é –≤–µ—Ä—Å–∏—é –Ω–µ—Ç. –ü–æ —Ä–µ—à–µ–Ω–∏—è–º –∑–∞–¥–∞—á —ç—Ç–æ–π –ø–æ–¥–±–æ—Ä–∫–∏ –≤–∏–¥–Ω–æ, —á—Ç–æ –∞–≤—Ç–æ—Ä –≤—Ç–æ—Ä–æ–π —Å—Ç–∞—Ç—å–∏ —è–≤–Ω–æ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω–µ–π –∏ –º–∞—Å—Ç–µ—Ä–æ–≤–∏—Ç–µ–µ –∞–≤—Ç–æ—Ä–∞ –ø–µ—Ä–≤–æ–π. –ù–æ –≤–æ–ø—Ä–æ—Å—ã –∫  —Ä–µ—à–µ–Ω–∏—è–º —Ç–æ–∂–µ –µ—Å—Ç—å:\n  2.1. –í —Ä–µ—à–µ–Ω–∏–∏  2-–π –∑–∞–¥–∞—á–µ (–∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤ –∫–∞–ø–∏—Ç–∞–ª–µ) –∞–≤—Ç–æ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç full join –∏ coalesce. –ù–æ —Å union –∑–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–∞–µ—Ç—Å—è –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–µ–µ:\n \nselect id, sum(cashflow) as sum_ from\n (select sender as id, -amount as cashflow from transactions\n union all\n select receiver as id,  amount as cashflow from transactions)\n group by id\n order by sum_ desc.\n 2.2. –†–µ—à–µ–Ω–∏–µ 4-–π –∑–∞–¥–∞—á–∏ (—Ä–∞–∑–Ω–∏—Ü–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏ –º–µ–∂–¥—É –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏) –ø–æ—á–µ–º—É-—Ç–æ –Ω–µ –ø—Ä–∏–≤–µ–¥–µ–Ω–æ. –ü—Ä–∏–≤–æ–∂—É –µ–≥–æ –∑–¥–µ—Å—å.\n \nselect user_id,\n        cast((julianday(action_date) - julianday(prev_action_date)) as                       integer) as days_elapsed\n from\n (select  user_id,\n          action_date,\n          lead(action_date) over(partition by user_id order by action_date                                      desc) as prev_action_date,\n          row_number()      over(partition by user_id order by action_date                                      desc) as row_number\n from users)\n where row_number = 1\n order by user_id\n --—á—Ç–æ–±—ã –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–∞–∑–Ω–∏—Ü—É –≤–æ –≤—Ä–µ–º–µ–Ω–∏ –º–µ–∂–¥—É –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏, –ª–æ–≥–∏—á–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–∫–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é lead, –∞ —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ, –ª–æ–≥–∏—á–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–∫–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é row_number. –î–ª—è –æ–±–µ–∏—Ö –æ–∫–æ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –ø–æ—Ä—è–¥–∫–µ —É–±—ã–≤–∞–Ω–∏—è –¥–∞—Ç.\n     2.3. –í —Ä–µ—à–µ–Ω–∏–∏ 5-–π –∑–∞–¥–∞—á–∏ (—Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏) –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã —Ç—Ä–∏ CTE (–æ–¥–∏–Ω —Å –æ–∫–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π) –∏ left join. –ù–æ –µ—Å–ª–∏ –≤ CTE –∏–ª–∏ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ —Ç–æ–ª—å–∫–æ row_number, –Ω–æ –∏ count, –∫–∞–∫  –æ–∫–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é, —Ç–æ –º–æ–∂–Ω–æ –æ–±–æ–π—Ç–∏—Å—å –±–µ–∑ left join, –∏ —Å–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ:\n \nselect user_id,\n        case when user_transactions_count > 1 then transaction_date\n              else Null end as superuser_date\n from\n (select user_id,\n         transaction_date,\n         row_number()  over(partition by user_id order by transaction_date)                 as row_number,\n          count(user_id)  over(partition by user_id)                                        as user_transactions_count\n from users)\n where (row_number = 2 and user_transactions_count > 1) or\n       (row_number = 1 and user_transactions_count = 1)\n order by  row_number desc, transaction_date\n -- –µ—Å–ª–∏ –¥–ª—è –∫–∞–∫–æ–≥–æ-—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–Ω–∞—á–µ–Ω–∏–µ –æ–∫–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ count —Ä–∞–≤–Ω–æ 1, —Ç–æ —ç—Ç–æ –º–∞—Ä–∫–µ—Ä, —á—Ç–æ —ç—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.\n    2.4.10-—é –∑–∞–¥–∞—á—É 10 –∞–≤—Ç–æ—Ä –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–ª, –∫–∞–∫ —Å–∞–º—É—é —Å–ª–æ–∂–Ω—É—é. –ü—Ä–∏–≤–µ–¥—ë–Ω–Ω–æ–µ –∞–≤—Ç–æ—Ä–æ–º —Ä–µ—à–µ–Ω–∏–µ  –∏ –≤–ø—Ä—è–º—å –¥–æ–≤–æ–ª—å–Ω–æ —Å–ª–æ–∂–Ω–æ–µ, –Ω–æ –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –µ–≥–æ –º–æ–∂–Ω–æ —Å–∏–ª—å–Ω–æ —É–ø—Ä–æ—Å—Ç–∏—Ç—å. –û—á–µ–≤–∏–¥–Ω–æ, —á—Ç–æ –µ—Å–ª–∏ –≤–∑—è—Ç—å –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ –∏–¥—É—â–∏–µ –¥—Ä—É–≥ –∑–∞ –¥—Ä—É–≥–æ–º –¥–∞—Ç—ã, —Ç–æ  –∏ juliandate, –∏ row_number –¥–ª—è –Ω–∏—Ö –±—É–¥—É—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –≤–æ–∑—Ä–∞—Å—Ç–∞—Ç—å –Ω–∞ –µ–¥–∏–Ω–∏—Ü—É –ø—Ä–∏ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏–∏ –¥–∞—Ç, –¢.–µ. –¥–ª—è –∫–∞–∫–æ–π-–ª–∏–±–æ –≥—Ä—É–ø–ø—ã –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ –∏–¥—É—â–∏—Ö –¥—Ä—É–≥ –∑–∞ –¥—Ä—É–≥–æ–º –¥–∞—Ç —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É juliandate –∏ row_number –±—É–¥–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π, –∏ –µ—ë –º–æ–∂–Ω–æ –≤–∑—è—Ç—å –∫–∞–∫ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–∞–∫–æ–π –≥—Ä—É–ø–ø—ã. –¢–µ–ø–µ—Ä—å –∑–∞–ø—Ä–æ—Å —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –¥–µ–ª–æ–º —Ç–µ—Ö–Ω–∏–∫–∏ üòä:\nwith group_by_projects as\n      (select start_date,\n              (cast(julianday(start_date) as integer) -\n               row_number() over(order by start_date)) as project_id\n from projects)\nselect start_date,\n        date(julianday(start_date) + count()), count() as project_duration\n from group_by_projects\n group by project_id\n order by project_duration\n     –ï—Å—Ç—å –µ—â—ë –ø–æ–¥–±–æ—Ä–∫–∞ –Ω–∞ \nhttps://tproger.ru/articles/5-zadanij-po-sql-s-realnyh-sobesedovanij/\n, –Ω–æ –æ–Ω–∞ —Å–æ–≤—Å–µ–º –º–∞–ª–µ–Ω—å–∫–∞—è. –ü—Ä–∏–≤–µ–¥—ë–Ω–Ω–æ–µ —Ç–∞–º —Ä–µ—à–µ–Ω–∏–µ 3-–π –∑–∞–¥–∞—á–∏ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è PostgreeSQL. –ê –≤ –æ–±—â–µ–º —Å–ª—É—á–∞–µ –ø—Ä–∏–¥—ë—Ç—Å—è –ø–æ–≤–æ–∑–∏—Ç—å—Å—è –ø–æ—Å–∏–ª—å–Ω–µ–µ:\n   –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç–æ–ª–±–µ—Ü, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –¥–ª—è —Ñ–∏–∫—Å–∞—Ü–∏–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤:\nalter table ClientBalance add  duplicates_id integer\n   –ó–∞—Ç–µ–º —Å–æ–∑–¥–∞—ë–º CTE, –≤ –∫–æ—Ç–æ—Ä–æ–º —Å –ø–æ–º–æ—â—å—é –æ–∫–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ row_number() –Ω—É–º–µ—Ä—É–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã, –∞ –∑–∞—Ç–µ–º –∏–Ω—Å–µ—Ä—Ç–∏–º –≤ –∏—Å—Ö–æ–¥–Ω—É—é —Ç–∞–±–ª–∏—Ü—É —Ç–µ —Å—Ç—Ä–æ–∫–∏ –∏–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ CTE, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥—É–±–ª–∏–∫–∞—Ç–∞ —Ä–∞–≤–µ–Ω 1:\n \nwith create_duplicates_id as\n      (select client_id,\n              client_name,\n              client_balance_date,\n              client_balance_value,\n              row_number() over(partition by client_id, client_name,                                           client_balance_date, client_balance_value                                      order by (select 0)) as duplicates_id\n       from ClientBalance)\ninsert into ClientBalance select * from create_duplicates_id where duplicates_id = 1\n   –î–∞–ª–µ–µ —É–¥–∞–ª—è–µ–º –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –≤—Å–µ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Ç.–µ. —Ç–µ –¥–∞–Ω–Ω—ã–µ, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥—É–±–ª—è is null):\n \ndelete from ClientBalance where duplicates_id is null\n   –ù—É –∏ –≤ —Ñ–∏–Ω–∞–ª–µ —É–¥–∞–ª—è–µ–º –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –Ω—É–∂–µ–Ω –¥–ª—è —Ñ–∏–∫—Å–∞—Ü–∏–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤, –≤–æ–∑–≤—Ä–∞—â–∞—è —Ç–∞–±–ª–∏—Ü—É –∫ –µ—ë –∏—Å—Ö–æ–¥–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ:\n \ndelete from ClientBalance where duplicates_id is null\n    –í –æ–±—â–µ–º-—Ç–æ —ç—Ç–æ –∏ –≤—Å—ë —Ç–æ–ª–∫–æ–≤–æ–µ, —á—Ç–æ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏. –û—Å—Ç–∞–ª—å–Ω–æ–µ –º–æ–∂–Ω–æ –æ–±—Å—É–∂–¥–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∫—É—Ä—å—ë–∑–æ–≤  üòä:\n  3.1. –í–æ—Ç –Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞  \nhttps://blog.sibirix.ru/colloquy-task/\n  –∞–≤—Ç–æ—Ä –Ω–∞–ø–∏—Å–∞–ª –ø—Ä–æ –∑–∞–¥–∞—á—É, –∫–æ—Ç–æ—Ä—É—é, –ø–æ –µ–≥–æ —Å–ª–æ–≤–∞–º, —Ä–µ—à–∞–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –∏–∑ –¥–µ—Å—è—Ç–∏, –∏ –µ—â—ë –æ–¥–∏–Ω –∏–∑ –¥–µ—Å—è—Ç–∏, –µ—Å–ª–∏ –Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å –∏ –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞—Ç—å. –ï—Å–ª–∏ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ç–∞–∫, —Ç–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –æ—á–µ–Ω—å –≥—Ä—É—Å—Ç–Ω–æ ‚Äì –∑–∞–ø—Ä–æ—Å —Ç–æ —Å–æ–≤—Å–µ–º –Ω–µ —Å–ª–æ–∂–Ω—ã–π ‚Äì –æ–¥–∏–Ω group by, –∏ –æ–¥–∏–Ω right join:\n \nselect Contractor.name, Sums.contr_sum\n from Contractor\n right join\n (select id_contr, sum(summa) as contr_sum\n from Operation\n group by id_contr) as Sums\n on Contractor.id_contr = Sums.id_contr\n3.2. –ù–∞ –•–∞–±—Ä–µ –µ—Å—Ç—å —Ä–∞–∑–±–æ—Ä —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è –ø–æ SQL –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ –≤ –¢–∏–Ω—å–∫–æ–≤. –û–Ω–æ –±—ã –∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–µ –∑–∞—Å–ª—É–∂–∏–≤–∞–ª–æ ‚Äì –∑–∞–¥–∞—á–∏ —Å–æ–≤—Å–µ–º –ø—Ä–æ—Å—Ç–µ–Ω—å–∫–∏–µ, –Ω–æ –¥–∞–∂–µ –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏, –∫ —á–µ–º—É –ø—Ä–∏–¥—Ä–∞—Ç—å—Å—è üòä ‚Äì –≤ —Ä–µ—à–µ–Ω–∏–∏ –≤—Ç–æ—Ä–æ–π –∑–∞–¥–∞—á–∏ –∞–≤—Ç–æ—Ä –ø–µ—Ä–µ–±–æ—Ä—â–∏–ª —Å count –∏ case wheh ‚Äì –∏—Ö —á–∏—Å–ª–æ –º–æ–∂–Ω–æ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –≤ –¥–≤–∞ —Ä–∞–∑–∞, –µ—Å–ª–∏ –≤—Å–ø–æ–º–Ω–∏—Ç—å –ø—Ä–æ avg:\nselect start_dttm::date as \"date\",¬†\n        avg(case when dozv_flg=1 then 1 end) as sla\n from calls\n where start_dttm::date between '2020-10-01' and                                      now()::date and dozv_flg in (1, 0)\n group by start_dttm::date\n    –ï—Å–ª–∏ —É –∫–æ–≥–æ-—Ç–æ –µ—Å—Ç—å —Å—Å—ã–ª–∫–∏ –Ω–∞ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –∑–∞–¥–∞—á–∏ –ø–æ SQL, –ø–∏—à–∏—Ç–µ, –ø–ª–∏–∑, –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö.\n–ë—É–¥—É –æ—á–µ–Ω—å –ø—Ä–∏–∑–Ω–∞—Ç–µ–ª–µ–Ω!\n \n ",
    "tags": [
        "sql",
        "join",
        "union",
        "–æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏"
    ]
}