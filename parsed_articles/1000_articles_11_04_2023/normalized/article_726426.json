{
    "article_id": "726426",
    "article_name": "GRE + IPSec чтобы слушать multicast в облаке",
    "content": "несмотря обилие статья ipsec linux каждый нужно слушать multicast виртуальный машина облако пример aws который нужно получать ipsec тоннель сталкиваться какимито проблема настройка жалеть сделать никакой заметка прошлый решать записывать пример конфигурация небольшой пояснение поделиться общественность надежда это комуто полезный итак обычно начало конфигурация должный договариваться сторона статья это условный  datacenter  конфигурация ike фаза1 ipsec фаза2 частность согласовывать psk preshared key фраза способ алгоритм аутентификация шифрование использоваться pfs perfect forward secrecy ваш публичный ip адрес peer vpn gateway ваш локальный подсеть который связывать interesting traffic также адресация gre тоннель обычно это делаться совместный заполнение табличка который пересылать почта итог собираться табличка такой вид сборный табличка утверждать параметр адрес вымышлять дальнейший конфигурация производиться aws виртуальный машина  ubuntu 20043 lts   linux strongswan u582k51301028aws  конфигурация  ipsecconf  ipsecconf комментарий жестко закреплять профиль безопасность аутентификация шифрование phase1 phase2 стоить указывать восклицательный знак    строка заданный конфигурация например ikeaes256sha256modp2048  параметр аутентификация шифрование ike     espaes256sha256modp2048  параметр аутентификация шифрование esp  включение возможность маршрутизировать ipv4 трафик необходимо включать sysctl netipv4ip_forward1 необходимо также настраивать iptables весь трафик interesting traffic datacenter remote address  1001530024  выходить source ip  1045817   следствие упаковываться ipsec тоннель служба strongswan   iptables t nat a postrouting d 1001530024 j snat tosource 1045817 также весь трафик лупбэк gre tunnel source datacenter  104471  выходить source ip  104461  iptables t nat a postrouting d 10447132 j snat tosource 104461 перезапуск strongswan использовать команда  ipsec restart  создавать gre тоннель c mtu 1476 лупбэк  ip tunnel add gre1 local 104461 remote 104471 mode gre ttl 255  ip link set gre1 up  ip addr add 10444630 dev gre1  ip link set dev gre1 mtu 1476  ip link set gre1 multicast on   должно умолчание включать пусть  ifconfig gre1 pointopoint 104445 схема gre тоннель linux мочь отвечать  gre keepalive  нужно либо разрешать следующий параметр sysctl netipv4confdefaultaccept_local1 sysctl netipv4confallaccept_local1 либо воспользоваться  безопасный replyonly решение  ответ gre keepalive результат должный видеть локальный сетевой интерфейс приходить пакет gre keepalive  104471  наш адрес  104461   содержать инкапсулировать обратный пакет  104461   104471  tcpdump n vv i eth0 proto 47  tcpdump listening on eth0 linktype en10mb ethernet capture size 262144 bytes  125320976489 ip tos 0xc0 ttl 255 id 38364 offset 0 flags none proto gre 47 length 48  104471  104461 grev0 flags none length 28  ip tos 0xc0 ttl 255 id 34625 offset 0 flags none proto gre 47 length 24  104461  104471 grev0 flags none length 4  greproto0x0 также должный видеть деинкапсулировать исходить пакет дамп трафик интерфейс gre1 tcpdump i gre1 n  130130985542 ip 104461  104471 grev0 length 4 greproto0x0 кроме стоять проверять раздел  security associations  вывод статус демон strongswan счетчик входящий исходящий трафик расти ipsec statusall   команда проверка статус ipsec  security associations  2 up 0 connecting  dctun2 established 2 hours ago 10112462224567117754214201775421420  dctun2 ikev2 spis a62a46f88ff6e9c2_i 50d27be1188d653d_r preshared key reauthentication in 104 minutes  dctun2 ike proposal aes_cbc_256hmac_sha2_256_128prf_hmac_sha2_256modp_2048  dctungre9  installed tunnel reqid 3 esp in udp spis c9788976_i 0e1488b7_o   dctungre 9  aes_cbc_256hmac_sha2_256_128modp_2048  13872 bytes_i 221 pkts 8s ago 3072 bytes_o 121 pkts 10s ago  rekeying in 34 minutes  dctungre9   10446132  10447132  dctuntcp10  installed tunnel reqid 1 esp in udp spis cb28899e_i ace88e01_o  dctuntcp10  aes_cbc_256hmac_sha2_256_128modp_2048 16800 bytes_i 200 pkts 30s ago 16800 bytes_o 200 pkts 30s ago rekeying in 34 minutes  dctuntcp10   104581728  1001530024 результат иметь рабочий gre over ipsec тоннель который смочь получать multicast сообщение подписка мультикастый помощь pim использовать python скрипт основа который взять скрипт  замечательный ответ стаковерфлоу  функция  send_dummy_joingroup rp_addr neighbor_ip  пример group   это адрес мультикаста группа который хотеть подписываться rp_addr   адрес multicast rendezvous point  1001530253  данный мы стороной дц neighbor_ip   адрес сосед пир gre тоннель  104445 маршрутизация мультикаста использовать  pimd  настройка описывать статья хотеть почитать русский pim советовать  статья  сеть самый маленький часть 93 мультикаста протокол pim",
    "tags": [
        "ipsec/gre",
        "gre",
        "ipsec",
        "multicast"
    ]
}