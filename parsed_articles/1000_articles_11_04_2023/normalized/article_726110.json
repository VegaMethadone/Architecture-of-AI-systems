{
    "article_id": "726110",
    "article_name": "Пишем форк Chrome, который рендерит браузер в терминале",
    "content": "несколько месяц назад писать  форка chrome превращать html svg  сегодня хотеть сделать нечто похожий заставлять выполнять рендеринг терминал    представлять ваш внимание  веббраузер carbonyl      отрисовка     терминал dec vt100    возможность отрисовка терминал довольно ограничивать гарантировать лишь рендеринг моноширинный символ неизменяемый сетка все существовать escapeпоследовательности позволять выполнять действие например перемещать курсор менять цвет текст отслеживать мышь некоторые сохраняться день физический терминал наподобие dec vt100 другой взять проект xterm    использование какогонибудь популярный эмулятор терминал мочь       перемещать курсор   записывать символ unicode   задавать фоновый основной цвет символ   использовать rgbпалитру 6x6x6 24битную rgbпалитру  colorterm  иметь значение  truecolor    символ unicode который мочь рендерять  это нижний половинный блок  u2584     знать общий случай ячейка иметь соотношение сторона 12 мочь рендерять идеально квадратный пиксел задавать качество фоновый цвет цвет верхний пиксел качество основной цвет  цвет нижний пиксел    давать подключать вывод  html2svg  программа rust     fn move_cursorx y usize usize      printlnx1bh y  1 x  1   fn set_foregroundr g b u8 u8 u8      printlnx1b382m r g b   fn set_backgroundr g b u8 u8 u8      printlnx1b482m r g b   fn print_pixels_pair     top u8 u8 u8     bottom u8 u8 u8     cursor usize usize       move_cursorcursor     set_backgroundtop     set_foregroundbottom     println     неплохо рендеринг текст мы нужно создавать помощь c новое устройство skia называть  textcapturedevice  заставлять вызывать написать rust функция  draw_text   html2svg  должный преобразовывать id глиф символ unicode     class textcapturedevice public skclipstackdevice    void ondrawglyphrunlistskcanvas                           const sktextglyphrunlist glyphrunlist                           const skpaint                           const skpaint paint override       получать позиция текст     auto position  localtodevicemaprectglyphrunlistorigin      for auto glyphrun  glyphrunlist        auto runsize  glyphrunrunsize       skautostarray64 skunichar unicharsrunsize         преобразовывать id глиф символ unicode       skfontprivglyphstounicharsglyphrunfont                                   glyphrunglyphsidsdata                                   runsize                                   unicharsget         отрисовывать текст терминал       draw_textunicharsdata runsize position paintgetcolor             еще однако центр текст искажать наш  textcapturedevice  учитывать наложение отрисовка прямоугольник очищать текст      добавлять код метод  drawrect   drawrrect  очищать текст выполнять заливка сплошной цвет     void drawrrectconst skrrect rect const skpaint paint override      drawrectrectrect paint   void drawrectconst skrect rect const skpaint paint override      if          paintgetstyle  skpaintstylekfill_style          paintgetalphaf  10               clear_textlocaltodevicemaprectrect          серый фон текстовый элемент возникать изза программный растеризатор рендерит текст наш битовый изображение давать удалять     chromiumthird_partyskiasrccoreskbitmapdevicecpp строка 521     void skbitmapdeviceondrawglyphrunlistskcanvas canvas                                         const sktextglyphrunlist glyphrunlist                                         const skpaint initialpaint                                         const skpaint drawingpaint      skassertglyphrunlisthasrsxform     loop_tiler drawglyphrunlistcanvas fglyphpainter glyphrunlist drawingpaint nullptr      это самый простой быть обрабатывать ввод     ввод  некоторый последовательность позволять эмулятор терминал отслеживать сообщать событие мышь например вводить  x1b1003h  терминал должный начинать отправлять событие следующий формат     fn report_mouse_movex y usize usize      writeget_stdin x1b35m y  1 x  1  fn report_mouse_downx y usize usize      writeget_stdin x1b0m y  1 x  1  fn report_mouse_upx y usize usize      writeget_stdin x1b0m y  1 x  1   схожий последовательность который использовать стилизация вывод префикс  x1b  называться control sequence introducer     carbonylbrowserbrowsermainthreadposttask     from_here     basebindonce         headlessbrowserimplonmousedowninput         x         y        мы нужно уведомлять браузер необходимость завершение задача один трудность нужно запрещать поток считывать stdin однако метод браузер должный вызываться основный поток счастие везде возможный пробрасывание сообщение помощь класс  taskrunner      carbonylsrcinputparserrs строка 69     for key in input      sequence  match sequence          sequencechar  match key              0x1b  sequenceescape             0x03  emiteventexit             key  emiteventkeypress  key                   sequenceescape  match key              b  sequencecontrol             bp  sequencedevicecontroldevicecontrolnew             0x1b                  emiteventkeypress  key 0x1b  continue             key                   emiteventkeypress  key 0x1b                  emiteventkeypress  key                                sequencecontrol  match key              b  sequencemousemousenew             ba  emiteventkeypress  key 0x26              bb  emiteventkeypress  key 0x28              bc  emiteventkeypress  key 0x27              bd  emiteventkeypress  key 0x25              _  sequencechar                  sequencemouseref mut mouse  parsemouse key         sequencedevicecontrolref mut dcs  parsedcs key         google рекомендовать устанавливать chrome     pipe  наш проект болееменее работать цена стабильный использование cpu 400 это считать iterm2 который использовать примерно 200 несколько проблема       рендеринг 5 fps требоваться слишком ресурс   выполнять рендеринг каждый кадр меняться   выводить символ меняться индивидуальный уровень    повышение безопасность современный браузер использоваться многопроцессный архитектура разделять вебсайт отдельный процесс снижать потенциальный ущерб вызывать уязвимость процесс рендерер работать среда песочница уровень ос блокировать определять системный вызов например доступ файловый система считаться процесс gpu иметь привилегия получать доступ процесс рендерер это сделать защита уязвимость gpu api наподобие webgl процесс браузер напротив считаться привилегированный поэтому свободно обраться любой процесс       capturepaintpreview  прекрасно подходить  html2svg  однако предназначать рендеринг реальный время корректный поддержка iframe вне процесс использовать вызов ipc совершать маршрут процесс браузер gpu рендерер скачивать аппаратно ускоренный изображение gpu объяснять удивительный нагрузка полоса пропускание память мочь отключать передача отключать аппаратный ускорение однако все равный быть сдерживать затратный механизм ipc    программный рендеринг попрежний активно использоваться мочь верить рано применяться умолчание время однопроцессность работать довольно просто однако сегодня общий область память сконфигурировать эффективный рендеринг помощь множество процесс смочь засовывать наш пиксел один этот область память мы достаточно просто уведомлять процесс браузер помощь простой сообщение ipc      подготовить общий память нужно реализовать  hostdisplayclient   softwareoutputdevice  управление собственный  layeredwindowupdater  реализовать  onallocatedsharedmemory      hostdisplayclient  выполняться процесс браузер вызываться процесс gpu ipc заканчивать весь этот мы нужно заставлять процесс gpu использовать наш собственный клиент дисплей добавлять  vizprocesstransportfactoryonestablishedgpuchannel  следующий     chromiumcontentbrowsercompositorviz_process_transport_factorycc строка 402     compositor_datadisplay_client        stdmake_uniquehostdisplayclientcompositor       stdmake_uniquecarbonylhostdisplayclient   carbonylsrcbrowserhost_display_clientcc строка 28     void layeredwindowupdateronallocatedsharedmemory     const gfxsize pixel_size     baseunsafesharedmemoryregion region       if region",
    "tags": [
        "chrome",
        "терминал",
        "браузер",
        "консоль"
    ]
}