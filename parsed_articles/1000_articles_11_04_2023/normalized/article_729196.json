{
    "article_id": "729196",
    "article_name": "Как заставить Jmeter собирать скриншоты графиков после тестов",
    "content": "привет хабр звать илья улизко заниматься нагрузочный тестирование дбо юла блок цифровой трансформация рсхбинтех статья поделиться вы опыт автоматизация сбор график grafana отсутствие установленный grafanaimagerender плагин сервер научать apache jmeter делать скриншот панель grafana мы понадобиться  selenium   browsermobproxy  использовать иллюстративный цель начинать скачивание необходимый зависимость сам jar файл скачать официальный maven репозиторий однако мало поэтому нужно рекурсивно скачать зависимость сам этот jarников мы помогать  сервис  jardownload вставлять окно maven xml  3 зависимость  selenium   proxy   webdrivermanager   нажимать кнопка submit затем download project итог получать архив 40 jar файл который класть apachejmeter543libjunit мы необходимо скачать webdriverы конкретный браузер  firefox   chrome  версия драйвер chrome все простой версия браузер такой версия драйвер например google chrome 111 драйвер нужный версия 111 firefox задача немного усложняться сайт mozilla  таблица  соответствие который помогать разбираться выбирать нужный драйвер гибкость рекомендовать скачать оба драйвер устанавливать оба браузер  все скачать складывать драйвер отдельный папка webdriverbin далее мы нужно создавать  api  ключ grafana быть отсылать заголовок запрос качество авторизация grafana слева нажимать configuration   api keys  new api key записывать гденибудь блокнот забывать api ключ быть далее передавать переменный api_key прописывать переменный окружение путь webdriverов apiключа необходимость все поменять один место затрагивать скрипт jmeter использовать linux поэтому приводить пример ос   echo export pathpathpathtowebdriverbin  profile  echo export api_grafanaeyjblablablablablablablablabla9  profile  source profile вытаскивать idшники панель дашборд дашборд разный микросервис шаблонизировать поэтому количество название панель везде одинаковый заходить любой дашборд переходить dashboard settings  json model помощь jsonpath  panelsidtitle  онлайн  сервис  получать список idшников панель массив далее быть передавать переменный panelids помощь панель разработчик определять селектор атрибут отвечать отображение картинка внутри панель дашборд метод проба ошибка подбирать атрибут classpanelcontainer отличие css selector  меняться разный панель быть передавать переменный selector приступать написание скрипт jmeter начало тест план создавать setup thread group внутри который создавать jsr223 sampler он заводить переменный который хранить время начало тесто инициализировать переменный from propsputteststart__time конец тест план создавать teardown thread group внутри который формировать jsr223 sampler он писать весь основной код затем заводить параметризовать переменный final string url  http101010103000d   final string dashboard  vqb0x5pvzsettings   final int panelids  new int262838372942233940362527    final string from  __pteststart   final string to  __time   final string selector  panelcontainer   final string api_key  systemgetenvapi_grafana    final double scale_monitor  1   final simpledateformat formatter  new simpledateformat_ddmmyyyy  обращать внимание переменный scale_monitor нужный нивелировать масштабирование монитор высокий разрешение например монитор разрешение 4k настройка параметр экран выставлять масштаб 150 значение переменная 15 масштаб 125 нужно выставлять  125 тд создавать настраивать объект browsermobproxy нужный запрос selenium добавляться заголовок авторизация api ключ browsermobproxy proxy  new browsermobproxyserver  proxysettrustallserverstrue  proxystart  proxyaddheaderauthorization bearer concatapi_key создавать веб драйвер конкретный реализация firefox передавать наш прокси добавлять заголовок также добавлять несколько настройка   webdriver driver  desiredcapabilities caps  new desiredcapabilities  proxy seleniumproxy  clientutilcreateseleniumproxyproxy  systemsetpropertysunjava2duiscale 1  systemsetpropertyfirefoxdriversystempropertybrowser_logfile null  firefoxoptions firefoxoptions  new firefoxoptions  firefoxoptionsaddargumentsprivate  capssetcapabilitymozfirefoxoptions firefoxoptions  capssetcapabilitycapabilitytypeaccept_insecure_certs true  capssetcapabilitycapabilitytypeaccept_ssl_certs true  capssetcapabilitycapabilitytypeproxy seleniumproxy  driver  new firefoxdrivercaps веб драйвер открывать браузер разворачивать весь экран делать авторизованный запрос url адрес grafana затем снимать скриншот панель id который собирать п 5  далее сохранять каждый скриншот собственный название указанный директория drivermanagewindowmaximize  for int i  0 i  panelidslength i   drivernavigatetourl      concatdashboard      concatorgid1viewpanel      concatstringvalueofpanelidsi      concatfrom      concatfrom      concatto      concatto  threadsleep2000  webelement elem  new webdriverwaitdriver 5      untilexpectedconditions      visibilityofelementlocatedbyclassnameselector  file screenshot  orgopenqaseleniumtakesscreenshot driver      getscreenshotasorgopenqaseleniumoutputtypefile  bufferedimage image  imageioreadscreenshot  int x  int elemgetlocationgetx  scale_monitor  int y  int elemgetlocationgety  scale_monitor  int width  int elemgetsizegetwidth  scale_monitor  int height  int elemgetsizegetheight  scale_monitor  bufferedimage elemscreenshot  imagegetsubimagex y width height  imageiowriteelemscreenshot png new filepathgrafanascreenshots      concatelemgetattributearialabel      substring0elemgetattributearialabellength6      concatformatterformatsystemcurrenttimemillis      concatpng   закрывать браузер останавливать прокси   driverquit  proxystop итог jsr223 sampler выглядеть следующий образ java code import netlightbodybmpbrowsermobproxy import netlightbodybmpbrowsermobproxyserver import netlightbodybmpcoreharharentry import netlightbodybmpclientclientutil import orgopenqaselenium import orgopenqaseleniumchromechromedriver import orgopenqaseleniumchromechromeoptions import orgopenqaseleniumfirefoxfirefoxdriver import orgopenqaseleniumfirefoxfirefoxoptions import orgopenqaseleniumremotecapabilitytype import orgopenqaseleniumremotedesiredcapabilities import orgopenqaseleniumsupportuiexpectedconditions import orgopenqaseleniumsupportuiwebdriverwait import javaximageioimageio import javaawtimagebufferedimage import javaiofile import javaioioexception import javatextsimpledateformat            final string url  http101010103000d     final string dashboard  vqb0x5pvzsettings     final int panelids  new int423     final string from  __pteststart     final string to  __time     final string selector  panelcontainer     final string api_key  systemgetenvapi_grafana      final double scale_monitor  1     final simpledateformat formatter  new simpledateformat_ddmmyyyy      browsermobproxy proxy  new browsermobproxyserver     proxysettrustallserverstrue     proxystart     proxyaddheaderauthorization bearer concatapi_key          try                 webdriver driver  getdriverproxy         drivermanagewindowmaximize         for int i  0 i  panelidslength i          drivernavigatetourl             concatdashboard             concatorgid1viewpanel             concatstringvalueofpanelidsi             concatfrom             concatfrom             concatto             concatto         threadsleep2000                  webelement elem  new webdriverwaitdriver 5             untilexpectedconditionsvisibilityofelementlocatedbyclassnameselector         file screenshot  orgopenqaseleniumtakesscreenshot drivergetscreenshotasorgopenqaseleniumoutputtypefile         bufferedimage image  imageioreadscreenshot         int x  int elemgetlocationgetx  scale_monitor         int y  int elemgetlocationgety  scale_monitor         int width  int elemgetsizegetwidth  scale_monitor         int height  int elemgetsizegetheight  scale_monitor         bufferedimage elemscreenshot  imagegetsubimagex y width height         imageiowriteelemscreenshot png new filepathtografanascreenshots                     concatelemgetattributearialabelsubstring0elemgetattribute",
    "tags": [
        "jmeter",
        "grafana",
        "автоматизация",
        "java",
        "рсхб",
        "рсхб интех",
        "рсхб в цифре",
        "тестирование"
    ]
}