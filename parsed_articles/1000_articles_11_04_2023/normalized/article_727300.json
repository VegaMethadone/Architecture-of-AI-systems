{
    "article_id": "727300",
    "article_name": "System.String не то, чем кажется. Представление строк в памяти .NET",
    "content": "тип systemstring  самый использовать разработка статья хотеть поговорить нюанс реализация начинать базовый информация systemstring  это ссылочный тип systemstring  это неизменяемый тип самый дело строка изменять крайний мера помощь безопасный код метод вроде trim insert пр изменять содержимое строка который первоначально ссылаться просто устанавливать ссылка новый заглядывать немного глубоко опираться наш вводный посмотреть это устраивать память начинать строка массив фиксировать размер однако стоить помнить экземпляр любой тип занимать память 2gb память этот ограничение распространяться x86 x64 система обычно gc знать сколько место память занимать объект создание основывать определенный тип свойство который меняться это наш случай давать разбираться кат строка ссылаться массив charом содержать внутри обращаться исходник обнаруживать замечательный поле  the string class represents a static string of characters  many of  the string methods perform some type of transformation on the current  instance and return the result as a new string  as with arrays character  positions indices are zerobased serializable nonversionable  this only applies to field layout systemruntimecompilerservicestypeforwardedfrommscorlib version4000 cultureneutral publickeytokenb77a5c561934e089 public sealed partial class string  остальной код    these fields map directly onto the fields in an ee stringobject  see objecth for the layout  nonserialize private readonly int _stringlength   for empty strings _firstchar will be 0 since strings are both nullterminated and lengthprefixed      the field is also readonly however string uses ctors that c doesnt recognise as ctors      so trying to mark the field as readonly causes the compiler to complain     nonserialized     private char _firstchar  остальной код  ссылка код класс string c  это управлять исходный файл больший часть код реализовать c ассемблер файл stringcs содержаться 9 метод который помечать extern аннотировать атрибут methodimplattribute параметр internalcall это говорить реализация предоставляться исполнять среда другой место разбираться переходить layout objecth увидеть    stringobject     special string implementation for performance       m_stringlength  length of string in number of wchars     m_firstchar     the string buffer     class stringobject  public object    остальной код      private     dword   m_stringlength wchar   m_firstchar     остальной код  ссылка код получаться gc видеть строка память именно следующий m_stringlength байт быть занимать массив данные строка такой случай фактический строковый данные быть храниться массив байт располагать другой место память поэтому обнаружение требоваться ссылка указатель поиск давать рассматривать картина сколько итог память занимать строка 8 sync  8 type  4 length  4extra field  2 null terminator  2  length  получаться 26  2  length   8 байт  syncblock 8 байт  method table pointer понятно 4 байт  m_stringlength member фактический количество символ строка 4 байт  extra field net 40 это место отводить m_arraylength предыдущий реализация длинный строка мочь отличаться длинный массив символ входить последующий версия этот память сохранять оставлять пустой вероятный исключение проблема код pinvoke 2  length  байт каждый символ начинать m_firstchar строка иметь кодировка unicode это очень важно знать понимать работа строка представлять кодировка практически являться ошибка набор кодированный символ unicode содержать 65536 символ это означать символ systemchar охватывать символ это приводить использование суррогат символ выше uffff представлять строка символ суть строка использовать форма кодировка символ utf16 большинство разработчик возможно нужно знать крайний мера знать стоять 2 байт  null terminator хотя строка заканчиваться null путать ключевой слово null точка зрение api массив символ завершаться null это означать передавать непосредственно неуправляемый функция какоголибо копирование условие взаимодействие указывать символ строка должный маршалированный unicode основной различие x86 x64 система заключаться размер dword  указатель память 32битных система составлять 4 байт 64битных 8 байт gc выделять память объект размер который знать ответ простой никак обычно сначала gc выделять память вызываться конструктор класс string иначе инициализация тип конструктор выделять память объект рассматривать пример работа строка часто использоваться stringbuilder stringformat который конечный итог использовать stringbuilder конечный итог вызываться метод stringbuildertostring внутри вызывать fastallocatestring класс string public override string tostring    остальной код   string result  stringfastallocatestringlength   остальной код  ссылка код рассматривать подробно   this class is marked eagerstaticclassconstruction because its nice to have this  eagerly constructed to avoid the cost of defered ctors i cant imagine any app that doesnt use string eagerstaticclassconstruction public partial class string    intrinsic   public static readonly string empty      internal static string fastallocatestringint length           we allocate one extra char as an interop convenience so that our strings are null        terminated however we dont pass the extra 1 to the string allocation because the base        size of this object includes the _firstchar field       string newstr  runtimeimportsrhnewstringeetypeptreetypeptrofstring length       debugassertnewstr_stringlength  length       return newstr     ссылка код оказываться этот просто обертка находить rhnewstring methodimplmethodimploptionsinternalcall runtimeimportruntimelibrary rhnewstring internal static extern unsafe string rhnewstringmethodtable peetype int length  internal static unsafe string rhnewstringeetypeptr peetype int length              rhnewstringpeetypetopointer length ссылка код метод помечать внешний он применять атрибут methodimplmethodimploptionsinternalcall это означать реализовать clr неуправляемый код конечный итог стек вызов оказываться написать рука ассемблерный функция   allocate a new string   ecx  methodtable   edx  element count fastcall_func   rhnewstring 8          push        ecx         push        edx           make sure computing the aligned overall allocation size wont overflow         cmp         edx max_string_length         ja          stringsizeoverflow           compute overall allocation size alignbase size  element size  elements 4         lea         eax edx  string_component_size  string_base_size  3         and         eax 4           ecx  methodtable          eax  allocation size          edx  scratch          inline_getthread    edx ecx         edx  getthread trashes ecx           ecx  scratch          eax  allocation size          edx  thread          mov         ecx eax         add         eax edx  offsetof__thread__m_alloc_context__alloc_ptr         jc          stringalloccontextoverflow         cmp         eax edx  offsetof__thread__m_alloc_context__alloc_limit         ja          stringalloccontextoverflow           ecx  allocation size          eax  new alloc ptr          edx  thread           set the new alloc pointer         mov         edx  offsetof__thread__m_alloc_context__alloc_ptr eax           calc the new object pointer         sub         eax ecx          pop         edx         pop         ecx           set the new objects methodtable pointer and element count         mov         eax  offsetof__object__m_peetype ecx         mov         eax  offsetof__string__m_length edx         ret ссылка код это также показывать коечто говорить ранее ассемблерный код фактически выделять память необходимый строка основа требовать длина передавать вызывать код один сторона строка являться фундаментальный тип именно поэтому должный максимально оптимизировать сторона такой базовый тип строка текстовый давать целое иметь больший сложность изначально предполагать информация предлагать статья являться исчерпывающий помогать понимать процесс происходить кат ваш проект",
    "tags": [
        "строки",
        "базовые типы",
        "string",
        "память .net",
        "clr",
        "system.string"
    ]
}