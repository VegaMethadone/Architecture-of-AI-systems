{
    "article_id": "726328",
    "article_name": "Дублирование данных для создания ограничений (контролей) на уровне БД",
    "content": "использование ограничение сторона база данные такой внешний ключ проверка значение требование уникальность вызывать спора среди разработчик аргуммент против оба сторона известный     рассматривать пример ограничение просто применяться реализовать дополнительный логика помощь дублирование некоторый данные        исходный типовой задача     пользователь группа роль   пользователь мочь входить группа указание роль   пользователь должный входить группа один тот роль несколько   некоторый роль группа один пользователь    это мочь       игрок команда роль команда капитан   учащийся группа роль староста   работник подразделение должность руководитель подразделение     типовой решение                             скрипт типовой решение                           скрипт максимально упрощать он отсутствовать мягкий удаление механизм версионирование данные проверка уникальность поле code оставлять регистрозависимый     create table publicusers  id integer not null generated always as identity start with 1 code varchar30 not null constraint users_pk primary key id constraint users_unique_code unique code   create table publicgroups  id integer not null generated always as identity start with 1 code varchar30 not null constraint groups_pk primary key id constraint groups_unique_code unique code   create table publicroles  id integer not null generated always as identity code varchar30 not null only_one bool not null default false constraint roles_pk primary key id constraint roles_unique_code unique code   create table publiclinks  id integer not null generated always as identitystart with 1 user_id integer not null group_id integer not null role_id integer not null constraint links_pk primary key id constraint links_fk_users foreign key user_id references publicusersid on delete restrict on update cascade constraint links_fk_groups foreign key group_id references publicgroupsid on delete restrict on update cascade constraint links_fk_roles foreign key role_id references publicrolesid on delete restrict on update cascade constraint links_unique_user_group_role unique user_id group_id role_id                            хотеться привлекать внимание некоторый момент       ограничение целесообразно явно указывать имя полагаться автоматический это удобный надежный поддержка возникать необходимость изменение удаление ограничение   целочисленный поле primary key использовать  generated always as identity  вместо  generated by default as identity   series  это позволять ранний этап выявлять ситуация бэкенд пытаться устанавливать значение поле  id  сожаление такой ошибка встречаться проект разный масштаб видимо быть встречаться   псевдо тип  series  удобный создавать последовательность связывать ее соответствующий поле однако имя последовательность присваиваться автоматически будущее приходиться угадывать правило автоматический именование объект явно получать описание значение умолчание поле    приводить выше типовой решение выполнение условие пользователь должный входить группа один тот роль несколько контролироваться ограничение  links_unique_user_group_role      возможно поступать условие некоторый роль группа один пользователь вариант       контроль перенести бэк подобный реализация рано поздно приводить нарушение условие возможный причина  ошибка реализация контроль разный приложение параллельный редактирование таблица разный сеанс   создавать уникальный частичный индекс который содержать id соответствовать роль подобный решение требовать изменение уникальный индекс изменение роль изменениепересоздание индекс возможно произвольный момент время тк необходимый соответствующий право доступ построение индекс большой таблица занимать время период устаревать индекс удалять новый еще создавать данные контролироваться должный заблокировать изменение   использовать подход дублирование данный поля  only_one  таблица  links  создавать уникальный частичный индекс который изменять изменение роль     подход дублирование данный                             скрипт корректировка типовой решение                           alter table publicroles add constraint roles_unique_id_only_one unique id only_one  alter table publiclinks add role_only_one bool not null  alter table publiclinks drop constraint links_fk_roles alter table publiclinks add constraint links_fk_roles_id_only_one foreign key role_id role_only_one references rolesid only_one on update cascade on delete restrict  create unique index links_upidx_group_role on publiclinks using btree group_id role_id where role_only_one     конечный вид таблица  roles   links  вносить изменение   create table publicroles  id integer not null generated always as identity code varchar30 not null only_one bool not null default false constraint roles_pk primary key id constraint roles_unique_code unique code constraint roles_unique_id_only_one unique id only_one   create table publiclinks  id integer not null generated always as identity user_id integer not null group_id integer not null role_id integer not null role_only_one bool not null constraint links_pk primary key id constraint links_unique_user_group_role unique user_id group_id role_id constraint links_fk_groups foreign key group_id references publicgroupsid on delete restrict on update cascade constraint links_fk_roles_id_only_one foreign key role_idrole_only_one references publicrolesidonly_one on delete restrict on update cascade constraint links_fk_users foreign key user_id references publicusersid on delete restrict on update cascade  create unique index links_upidx_group_role on publiclinks using btree group_id role_id where role_only_one                                                      заполнение данный проверка                           создавать три игрок два команда два роль роль капитан назначать один игрок   insert into publicusers code valuesuser1 user2 user3  insert into publicgroups code valuesбелая команда зеленый команда  insert into publicroles code only_one valuesигрок false капитан true   помещать игрок первый команда один присваивать роль капитан     insert into publiclinks user_id group_id role_id role_only_one values1 1 1 false 1 1 2 true 2 1 1 false 3 1 1 false   попытка добавлять еще один капитан получать ошибка вид  error duplicate key value violates unique constraint links_upidx_group_role     однако таблица  roles  роль капитан снимать признак  only_one  забывать каскадный обновляться соответствующий запись links перестраиваться индекс  links_upidx_group_role  смочь добавлять команда дополнительный капитан ошибка    какойто роль необходимо устанавливать признак  only_one  смочь это сделать пока откорректировать данные  links                           рассматривать решение иметь следующий недостаток       явный дублирование данные  only_one    необходимо правильно заполнять поле  role_only_one  таблица  links  создание связь   добавляться уникальный индекс который создаваться ограничение  roles_unique_id_only_one     многий задача высокий качество давать который обеспечивать ограничение уровень бд уравновешивать перечисленный недостаток",
    "tags": [
        "constraints",
        "sql",
        "postgresql"
    ]
}