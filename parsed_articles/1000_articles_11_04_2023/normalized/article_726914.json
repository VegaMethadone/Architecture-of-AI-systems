{
    "article_id": "726914",
    "article_name": "Kubernetes Volumes: реплицированная MongoDB со StatefulSet",
    "content": "автор статья рустем галиев ibm senior devops engineer  integration architect привет хабр kubernetes  statefulset   это реплицировать группа podов аналогичный replicasetам каждый реплика получать постоянный имя хост уникальный индекс например  database0   database1  т д каждый реплика создаваться порядок самый низкий самый высокий индекс создание блокироваться тот пора пока предыдущий индекс становиться работоспособный доступный это относиться масштабирование удаление  statefulset  каждый управляемый под реплика также удаляться порядок убывание это также относиться уменьшение количество реплика оказываться простой набор требование значительно упрощать развертывание приложение хранение данные kubernetes например сочетание стабильный имя хост например  database0  ограничение порядок означать реплика кроме первый мочь надежно ссылаться  database0  цель обнаружение установление кворум репликация сегодня развертывать реплицировать кластер mongodb  statefulset  начало создавать реплицировать набор три модуль mongodb использовать объект  statefulset  основной контейнер приложение использовать образ контейнер  mongo3424  запускать процесс  mongod  запускать  mongod  запускаться процесс mongodb запускаться фоновый режим процесс несколько параметр умолчание например сохранение данный  datadb  запуск порт 27017  apiversion appsv1 kind statefulset metadata   name mongo spec   servicename mongo   replicas 3   selector     matchlabels       app mongo   template     metadata       labels         app mongo     spec       containers        name mongodb         image mongo3424         command          mongod          replset          rs0         ports          containerport 27017           name peer пока создавать объект быть вносить дополнительный изменение манифест yaml инициализировать кластер mongodb помощь init container автоматизировать развертывание наш кластер mongodb основа statefulset собираться добавлять дополнительный контейнер под выполнение инициализация настраивать модуль создание новый образ docker собираться использовать  configmap  добавление скрипт существующий образ mongodb собираться запускать скрипт использовать контейнер инициализация контейнер инициализация init container  это специализированный контейнер который запускаться запуск под обычно использоваться такой случай небольшой объем работа настройка который полезно выполнять запуск основный приложение определение под отдельный список  initcontainers  который определять контейнер инициализация последний этап производство наш кластер mongodb являться добавление проверка жизнеспособность наш контейнер обслуживать mongo apiversion appsv1 kind statefulset metadata   name mongo spec   servicename mongo   replicas 3   selector     matchlabels       app mongo   template     metadata       labels         app mongo     spec       containers        name mongodb         image mongo3424         command          mongod          replset          rs0         ports          containerport 27017           name web         livenessprobe           exec             command              usrbinmongo              eval              dbserverstatus           initialdelayseconds 10           timeoutseconds 10        this container initializes the mongodb server then sleeps        name initmongo         image mongo3424         command          bash          configinitsh         volumemounts          name config           mountpath config       volumes        name config         configmap           name mongoinit заменять содержимое файл  mongoyaml  следующий шаг создавать  configmap  имя  mongoinit  создание карта конфигурация обращать внимание pod монтировать configmap volume имя  mongoinit  configmap содержать скрипт который выполнять наш инициализация вопервых скрипт определять работать  mongo0  находиться  mongo0  создавать  replicaset  помощь тот команда который ранее запускать императивный находиться реплика mongoждет пока  replicaset exists  правильно сказать появляться затем регистрироваться мембер  replicaset  следующий манифест yaml содержать полный объект  configmap  apiversion v1 kind configmap metadata   name mongoinit data   initsh      binbash       need to wait for the readiness health check to pass so that the      mongo names resolve this is kind of wonky     until ping c 1 hostnamemongo do       echo waiting for dns hostnamemongo       sleep 2     done      until usrbinmongo eval printjsondbserverstatus do       echo connecting to local mongo       sleep 2     done     echo connected to local      hostmongo0mongo27017      until usrbinmongo hosthost eval printjsondbserverstatus do       echo connecting to remote mongo       sleep 2     done     echo connected to remote      if  hostname  mongo0  then       until usrbinmongo hosthost evalprintjsonrsstatus               grep v no replset config has been received do         echo waiting for replication set initialization         sleep 2       done       echo adding self to mongo0       usrbinmongo hosthost           evalprintjsonrsaddhostnamemongo     fi      if  hostname  mongo0  then       echo initializing replica set       usrbinmongo evalprintjsonrsinitiate           _id rs0 members _id 0             host mongo0mongo27017     fi     echo initialized замечать скрипт определенный  configmap  немедленно завершать работа это важный использование  initcontainers  каждый контейнер инициализация прежде запускаться ждать пока предыдущий контейнер выполнять основной контейнер приложение ожидать завершение контейнер инициализация скрипт завершаться основной сервер монго запуститься сначала создавать объект  configmap  kubectl apply f mongoconfigmapyaml затем создавать объект  statefulset  который смочь ссылаться  configmap  имя kubectl apply f mongoyaml создание различие  replicaset   statefulset  становиться очевидный учитывать создание под  statefulset  потребоваться некоторый время приходиться повторно запускать один тот команда несколько пока достигать количество три реплика kubectl get pods это увидеть  replicaset  важный отличие вопервых каждый реплицировать pod иметь числовой индекс 0 1 вместо случайный суффикс который добавляться контроллер  replicaset  вовторых под медленно создаваться порядок сразу это  replicaset  предоставление mongodb сервис создание  statefulset  мы также необходимо создавать безголовый служба управление запись dns  statefulset  kubernetes сервис называться безголовый виртуальный ipадреса кластер поскольку  statefulsets  каждый pod иметь уникальный идентификатор самый дело иметь смысл иметь ipадрес балансировка нагрузка реплицировать сервис мочь создавать безголовый сервис использовать  clusterip  none спецификация сервис apiversion v1 kind service metadata   name mongo spec   ports    port 27017     name peer   clusterip none   selector     app mongo создание служба обычно заполняться четыре запись dns обычно создаваться  mongodefaultsvcclusterlocal  отличие стандартный служба поиск dns этот имя хост предоставлять адрес  statefulset  кроме создаваться запись  mongo0mongodefaultsvcclusterlocal  также  mongo1mongo   mongo2mongo  каждый разрешаться определенный ipадрес индекс реплика  statefulset  такой образ помощь  statefulsets  получать четко определенный постоянный имя каждый реплика набор этот часто бывать очень полезно настройка решение хранение данные репликация создавать служба помощь следующий команда kubectl apply f mongoserviceyaml объединять  statefulsets   pvc  проверка живучесть защищать масштабировать облачный установка mongodb работать kubernetes хотя тема речь идти mongodb шаг создание  statefulset  управление другой решение хранение очень похожий следовать аналогичный шаблон завершение хотеть приглашать  бесплатный урок  мой коллега otus рассказывать устраивать мониторинг кластер компонент приложение кластер изучать различный подход мониторинг подход мониторинг приложение компонент кластер основной метрика kubernetes также узнавать кластеризациюфедерация prometheus дополнительный хранилище метрика prometheus vict",
    "tags": [
        "mongodb",
        "kubernetes",
        "statefullset"
    ]
}