{
    "article_id": "725606",
    "article_name": "Миграция PostgreSQL с DBaaS на дроплет Digital Ocean",
    "content": "недавно наш клиент обращаться мы один интересный задача нужно перенести весь свой кластер postgresql dbaas database as a service дроплет рамка digitalocean причина переход dbaas дроплета низкий стоимость этот задача оказываться довольно сложный поскольку документация digitalocean четко сказать настоящий время поддерживать миграция база данные один кластер digitalocean другой кластер рамка digitalocean короче говорить мы нужно переносить база данные свой сила предоставлять клиент вариант решение задача pg_dump логический репликация метод pg_dump предполагать определенный период простой должный создавать дамп затем восстанавливать новый сервер логический репликация оставлять исходный база данные рабочий состояние пока данные копироваться новый база данные достигать желать состояние мочь переключаться новый база данные миграция помощь логический репликация таблица который необходимо реплицировать должный иметь первичный уникальный ключ предварительный требование миграция перенести существующий база данные кластер база данные digitalocean мы необходимо убеждаться исходный база данные включать логический репликация получать учетный данные подключение исходный база данные отключать обновлять любой файрвол база данные получать rootправа  подготовка база данные миграция проведение сам миграция мы нужный rootправа исходный база данные сделать база данные общедоступный  миграция база данные имя хост ipадрес исходный база данные должный доступный публичный интернет информация публичный подключение база данные digitalocean находиться раздел connection details панель управление база данные разрешать удалять подключение  вопервых убеждаться база данные разрешать удалять подключение это определяться переменный база данные listen_addresses который разрешать удалять подключение значение равный   проверять течь значение выполнять терминал postgresql psql следующий запрос show listen_addresses if enabled the command line returns listen_addresses   1 row ваш результат другой мочь разрешать удаленный подключение ваш база данные выполнять следующий запрос alter system set listen_addresses   также должный изменять ваш локальный ipv4соединение разрешать входить ipадреса нужно находить файл конфигурация pg_hbaconf помощь следующий запрос show hba_file открывать pg_hbaconf текстовый редактор ваш выбор например nano nano pg_hbaconf раздел ipv4 local connections находить заменять ipадрес 00000 разрешать ipv4адреса  type database user address method    ipv4 local connections host all all 00000 md5  ipv6 local connections host all all 0 md5 включение логический репликация большинство поставщик облачный база данные логический репликация включать умолчание логический репликация включать переносить база данные локальный сервер ваш база данные подготовить логический репликация процесс миграция работать поскольку база данный перемещать ваш схема сам данные убеждаться логический репликация включать выполнять следующий запрос терминал postgresql psql show wal_level if enabled the output returns wal_level  logical 1 row if the output is different enable logical replication in your database by setting wal_level to logical alter system set wal_level  logical изменение максимальный количество слот репликация включение логический репликация мы нужно убеждаться значение max_replication_slots ваш база данные равный превышать количество база данные ваш postgresql сервер проверять течь значение выполнять следующий запрос терминал postgresql psql show max_replication_slots вывод выглядеть следующий образ max_replication_slots   1 row этот значение мало количество база данные наш postgresql сервер изменять выполнять следующий запрос use_your_number  это количество база данные наш сервер alter system set max_replication_slots  use_your_number перезагружать сервер проблема который мочь сталкиваться время миграция реализовывать логический репликация первичный ключ мочь сталкиваться некоторый проблема существовать разный метод реализация логический репликация столбец первичный ключ который  использование уникальный ключ метод реализоваться помощь сам набор шаг который собираться выполнять технический аспект также аналогичный просто вместо первичный ключ обновление быть происходить уникальный ключ предостережение поддерживать deleteupdate репликационный идентификатор уникальный индекс использовать репликационный идентификатор разрешать nullзначения использоваться replica identity full репликационный идентификатор находить подходящий индекс мочь устанавливать значение full случай столбец таблица коллективно выступать роль первичный ключ изза дополнительный логирование создаваться огромный количество wal метод медленно традиционный следовать учитывать мы нужно устанавливать репликационный идентификатор full таблица который переноситься логически unique ключ иначе deleteupdate поддерживаться данные форка dbaas быть синхронизировать новый виртуальный машина дроплета мы нужно выполнять метод pg_dump pg_restore последовательность возникать вопрос мы дамп последовательность почему мочь реплицировать помощь логический репликация логический репликация предназначать отслеживание изменение wal информирование подписчик текущий состояние значение довольно противоречивый реплицировать последовательность текущий значение последовательность равный значение храниться wal компенсировать это документация postgresql предлагать вручную скопировать значение последовательность использовать копирование такой утилита pg_dump сделать дамп последовательность форка бд dbaas останавливать форк бд dbaas восстанавливать последовательность новый дроплета отключать логический подписка ниже приводить краткий обзор сделать миграция среда исходный кластер  dbass digital ocean место назначение  дроплета digital ocean процесс клиент выбирать миграция посредством логический репликация сокращать время простой целевой виртуальный машина устанавливать  дистрибутив percona postgresql 137  перенести место назначение роль исходный кластер тот dbass сформировывать список таблица который первичный ключ проинформировать некоторый таблица клиент добавлять первичный ключ остальной таблица сформировывать уникальный ключ устанавливать виртуальный машина расширение который исходный кластер сформировывать дамп схема исходный кластер тот dbass восстанавливать схема место назначение тот дроплетый скорректировать исходный кластер место назначение параметр связывать логический репликация такой max_replication_slots max_logical_replication_workers max_wal_senders настраивать логический репликация создавать публикация подписка исходный кластер место назначение место назначение синхронизировать отключать подписчик сформировывать дамп последовательность исходный кластер восстанавливать место назначение скорректировать файл listen_address pg_hba место назначение сбросить подписчик место назначение заключение знать postgresql  это объектнореляционный система управление база данные открытый исходный код создавать упор расширяемость скорость целостность данные поддержка параллелизм делать полностью совместимый acid смочь реализовать миграция данные клиент dbass дроплета использовать один замечательный фич postgresql логический репликация также смочь сформировывать дамп последовательность исходный кластер восстанавливать место назначение заключение статья приглашать желающий  открытый занятие  автоматизация развертывание кластер postgresql база patroni kubernetes который пройти рамка онлайнкурс postgresql cloud solutions открытый урок разыгрывать книга руководитель курс евгений аристов  postgresql 14 оптимизация kubernetes кластер облако регистрация открытый урок",
    "tags": [
        "postgresql cloud solutions",
        "postgresql",
        "patroni",
        "kubernetes",
        "digital ocean",
        "dbaas",
        "миграция"
    ]
}