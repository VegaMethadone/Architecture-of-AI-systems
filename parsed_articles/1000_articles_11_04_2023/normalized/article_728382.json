{
    "article_id": "728382",
    "article_name": "Агрегат WITH ROLLUP",
    "content": "статья обсуждать устраивать агрегат with rollupиспользование предложение with rollup позволять выполнять несколько уровень агрегация один операторенапример предполагать некий данные продажахэто тот данный который использовать серия статья оператор pivot create table sales empid int yr int sales money insert sales values1 2005 12000 insert sales values1 2006 18000 insert sales values1 2007 25000 insert sales values2 2005 15000 insert sales values2 2006 6000 insert sales values3 2006 20000 insert sales values3 2007 24000 мочь написать простой запрос c агрегат вычисление общий объем продажа год select yr sumsales as sales from sales group by yr ожидаться запрос возвращать строка  один каждый год yr          sales   2005        2700000 2006        4400000 2007        4900000 план запрос представлять себя простой stream aggregate    compute scalardefineexpr1004case when expr10100 then null else expr1011 end        stream aggregategroup bysalesyr defineexpr1010count_bigsalessales expr1011sumsalessales             sortorder bysalesyr asc                  table scanobjectsales предполагать хотеть вычислять продажа год общий продажим мочь написать запрос union all select yr sumsales as sales from sales group by yr union all select null sumsales as sales from sales запрос вернуть правильный результат yr          sales   2005        2700000 2006        4400000 2007        4900000 null        12000000 однако план запрос содержать просмотр агрегирование один вычисление продажа год второй вычисление общий продажа   concatenation        compute scalardefineexpr1004case when expr10230 then null else expr1024 end            stream aggregategroup bysalesyr defineexpr1023count_bigsalessales expr1024sumsalessales                 sortorder bysalesyr asc                      table scanobjectsales        compute scalardefineexpr1010null             compute scalardefineexpr1009case when expr10250 then null else expr1026 end                  stream aggregatedefineexpr1025count_bigsalessales expr1026sumsalessales                       table scanobjectsales мочь улучшать ситуация добавлять исходный запрос предложение with rollup select yr sumsales as sales from sales group by yr with rollup запрос просто использовать эффективный план который просмотр   compute scalardefineexpr1004case when expr10050 then null else expr1006 end        stream aggregategroup bysalesyr defineexpr1005sumexpr1007 expr1006sumexpr1008             stream aggregategroup bysalesyr defineexpr1007count_bigsalessales expr1008sumsalessales                  sortorder bysalesyr asc                       table scanobjectsales план запрос нижний stream aggregate потоковый агрегат исходный запрос rollup этот обычный агрегирование который реализовать помощь stream aggregate пример  hash aggregate  попробовать добавлять предложение option hash group приводить выше запрос весь это прекрасный распараллеливаться верхний stream aggregate  это специальный агрегат который вычислять rollup сожаление sql server 2005 невозможно определять план запрос агрегат реализовать rollup однако проблема исправлять графический xmlпланах sql server 2008 агрегат rollup реализоваться использование stream aggregate распараллеливаться простой пример потоковый агрегат rollup возвращать каждый получать вход предагрегированный строка вычислять промежуточный итог столбец sales обработка последний строка агрегат добавлять один дополнительный строка общий сумма поскольку sql отсутствовать концепция значение all столбец yr последний строка устанавливать значение null yr значение null являться допустимый мочь идентифицировать строка rollup помощь конструкция groupingyr подставлять вместо all select       case when groupingyr  0             then cast yr as char5             else all       end as yr       sumsales as sales from sales group by yr with rollup yr    sales   2005  2700000 2006  4400000 2007  4900000 all   12000000 также вычислять несколько уровень rollup один запросенапример хотеть рассчитать продажа сотрудник затем год каждый select empid yr sumsales as sales from sales group by empid yr with rollup empid       yr          sales    1           2005        1200000 1           2006        1800000 1           2007        2500000 1           null        5500000 2           2005        1500000 2           2006        600000 2           null        2100000 3           2006        2000000 3           2007        2400000 3           null        4400000 null        null        12000000 запрос стоить отмечать несколько моментоввопервый поскольку комбинация значение столбец empid yr уникальный предложение with rollup запрос просто вернуть исходный данныеоднако предложение with rollup запрос давать желать результатвовторых порядок столбец предложение group by соответствовать предложение with rollupчтобы понимать почему просто попробовать запрос поменять место столбец empid yrпосле вместо вычисление продажа сотрудник сначала быть продажа год план запрос идентичный план запрос предыдущий запрос исключение группироваться столбец empid yr столбец empidкак предыдущий план запрос включать потоковый агрегат нижний являться обычный верхний вычислять rollupпотоковый агрегат rollup фактически вычислять промежуточный итог общий объем продажа сотрудник год общий объем продажа сотрудник годыв таблица низко продемонстрировать происходить вычисление rollup empid yr sumsales  by empid yr sumsales  by empid sumsales 1 2005 1200000 1200000 1200000 1 2006 1800000 3000000 3000000 1 2007 2500000 5500000 5500000 1 null  5500000 5500000 2 2005 1500000 1500000 7000000 2 2006 600000 2100000 7600000 2 null  2100000 7600000 3 2006 2000000 2000000 9600000 3 2007 2400000 4400000 12000000 3 null  4400000 12000000 null null   12000000",
    "tags": [
        "sql server"
    ]
}