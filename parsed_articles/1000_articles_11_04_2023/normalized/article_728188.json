{
    "article_id": "728188",
    "article_name": "Mediastreamer2. Применение Lua-машины в фильтрах",
    "content": "этот публикация являться дополнительный глава мой руководство mediastreamer2 обновлять версия руководство свободно скачать   яндексдиск  глава 8применение luaмашины фильтр ранее  рассматривать фильтр поведение который старт управлять лишь частично  вызывать предусмотренный метод статья создавать программировать фильтр поведение который полностью определяться встроенный luaмашиной точно загружать она скрипт это позволять менять алгоритм работа фильтр перекомпиляция исполнять код код программа данный глава скачать github приступать практический реализация вспомнить создаваться новый фильтр см глава 4  схема источник звуковой сигнал либо сигнал линейный вход звуковой плата  sound_card_read  либо генератор dtmfсигнала  dtmf_generator  далее данные попадать вход разрабатывать luaфильтра  lua_filter  который осуществлять преобразование соответствие загружать скрипт затем данные поступать разветвитель tee который входной поток образовывать два копия который выдавать выход этот поток поступать регистратор  recorder звуковой карта воспроизведение  sound_card_write  регистратор сохранять диск формат raw  wav файл заголовок такой образ смочь прослушивать записывать результат работа luaфильтра 81реализация фильтр luaфильтр устраивать следующий образ фильтр инициализация создаваться экземпляр luaмашины перемещение данные фильтр показывать рисунок 81  рисунок 81перемещение данные внутри luaфильтра   поступать вход блок данные передаваться luамашину ее стек помощь два глобальный переменный lf_data   длинный строка который находиться байт блок данные lf_data_len   целый число длина строка lf_data байт два переменный помещать стекать исполнение передаваться luaмашине активироваться загружать скрипт преобразовывать получать стек строка данные результирующий блок данные снова помещаться длинный строка класться глобальный переменный затем стек использоваться другой пара глобальный переменный lf_data_out   строка который находиться байт блок выходной данные lf_data_out_len   целый число длина строка lf_data_out байт затем фильтр извлекать данные стек формироваться выходной блок данные который выставляться выход фильтр такой образ применение luaфильтра давать возможность менять алгоритм обработка поведение схема передача медиапоток перекомпиляция остановка основной приложение тот лет фактически передача блок luамашину обратно использоваться текстовый строка соответствующий размер изощренный вариант обмен данные мочь реализовать помощь тип userdefined types  httpswwwluaorgpil28html  реализация лежать вне рассмотрение данный книга поскольку известно блок входной данные состоять 16битных отсчет знакомый получать скрипт строка каждый отсчет закодировать два байт дополнительный код 82организация скрипт изначально фильтр содержать исполняемый luaскрипта должный туда загружать целесообразно разделять скрипт два часть первый часть выполнять начальный инициализация этот часть скрипт выполняться однократно второй часть предназначать многократный циклический выполнение каждый такт тикер быть называть часть скрипт преамбуласкрипт выполняться однократно поступление первый такт тикер телоскрипт этот часть запускаться выполнение каждый такт тикер 10 мс загрузка преамбула тело фильтр предусматривать метод lua_filter_set_preamble lua_filter_run соответственно 821преамбула скрипт это однократно выполнять luaкод который выполняться подключение библиотека объявление функция использовать тело скрипт необходимый начальный инициализация переменный поскольку преамбула запускаться первый такт тикер мы необходимо определять она код запускать тикер использоваться метод lua_filter_set_preamble который качество первый аргумент передаваться привычный указатель структура фильтр второй аргумент текст преамбула преамбула записатьперезаписывать фильтр неоднократно любой время каждый перезапись преамбула следовать ее однократный выполнение близкий такт 822тело скрипт отличие преамбула этот часть скрипт выполняться каждый такт тикер умолчание каждый 10мс данный часть код записатьперезаписывать фильтр любой время определять метод lua_filter_run аргумент аналогичный преамбула 823остановка скрипт любой момент скрипт останавливать поставлять пауза метод lua_filter_stop вызов метод входить блок данные передаваться сразу выход фильтр миновать обработка скрипт возобновлять обработка вызывать метод lua_filter_run подставлять вместо указатель текст тело скрипт нулевой указатель либо указатель новый текст 824дополнительные функция скрипт мочь извлекать данные строка помещать результат свой работа обратно строка мы понадобиться два функция доступ данные get_sample append_sample  первый выполнять извлечение отсчет сигнал строка помощь второй добавлять длинный строка отсчет текст приводить листинг 81  листинг 81функции доступ данные  funcslua   функция извлекать строка 16битный отсчет function get_samples sample_index local byte_index  2sample_index  1 local l  stringbytes byte_index local h  stringbytes byte_index  1 local v  256  h  l if h  128 then v   v  1  65535 end return v end   функция добавлять строка 16битный отсчет function append_samples sample_value local v  mathfloorsample_value  05 if v  0 then v   v v  v  1  65535 end local h  v  256 local l  v  h  256 return  s  stringcharl h end  функция get_sample использоваться доступ отсчет сигнал храниться строка возвращать 16битный отсчет извлекать строка s  заданный индекс отсчет sample_index определяться индекс 2 байт который храниться далее этот два байт собираться 16ти битный число поскольку отсчет этот число знакомый байт хранить число дополнительный код мы требоваться приводить число обычный вид сначала определять состояние 15го бит число равный 0 число положительный дополнительный преобразование нужно бить устанавливать число отрицательный вычитать число единица делать инверсия каждый бит умножать 1 функция append_sample использоваться сборка строка выходной данные добавлять первый свой аргумент строка байт представлять второй аргумент отсчет сигнал дополнительный код файл функция называться funcslua нужно помещать каталог который запускаться код фильтр 825пример скрипт создавать скрипт который просто пробрасывать данные сквозь менять преамбула показывать листинг 82  листинг 82преамбула скрипт  preambula2lua  скрипт выполняться luaфильтре преамбула  подключать файл функция доступ данные require funcs preambula_status  0 body_status  0  этот переменная инкрементироваться тело скрипт local greetings  hello world from preambulan  приветствие printgreetings return preambula_status  преамбула подключать файл функция доступ данные сигнал  funcslua  тело скрипт представлять листинг 83  листинг 83тело скрипт  body2lua  скрипт выполнять luaфильтре тело скрипт  перелагать результат работа выходной переменный lf_data_out  if lf_data_len  nil then printbad lf_data_lenn end for i  1 lf_data_len2 do s  get_samplelf_data i lf_data_out  append_samplelf_data_out s end lf_data_out_len  stringlenlf_data_out return body_status  тело скрипт делаться особенный просто отсчет входной строка переноситься один выходной строка очевидно функция get_sample append_sample располагать любой преобразование отсчет возможный вариант фильтр обрабатывать отсчет управлять другой фильтр соответствие входной данные следовать обращать внимание написание скрипт удобно первый строчка файл поставлять комментарий содержать имя файл это сделать пример возникновение ошибка диагностический сообщение первый место оказываться имя файл который выявлять ошибка становиться ясно часть скрипт иметься ввиду  preambula2lua  filter lua_filter lua error lua error descriptionstring  preambula2lua 12 attempt to perform arithmetic on a nil value 83исходный код фильтр заголовочный файл фильтр выглядеть следующий образ листинг 84 заголовочный файл luaфильтра ifndef lua_filter_h define lua_filter_h  подключать заголовочный файл перечисление фильтр медиастример  include mediastreamer2msfilterh  подключать интерпретатор lua  include lua53luah include lua53lauxlibh include lua53lualibh  задавать числовой идентификатор нов",
    "tags": [
        "mediastreamer2",
        "lua",
        "c",
        "voip",
        "dsp"
    ]
}